<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω ƒë·ªÅ thi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-4 text-center">üë©‚Äçüè´ Qu·∫£n l√Ω ƒë·ªÅ thi</h1>

  <!-- Form t·∫°o ƒë·ªÅ thi -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h3 class="card-title">T·∫°o ƒë·ªÅ thi m·ªõi</h3>
      <form id="createExamForm">
        <div class="mb-3">
          <label class="form-label">T√™n ƒë·ªÅ thi</label>
          <input type="text" id="title" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">M√¥n h·ªçc</label>
          <input type="text" id="subject" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Th·ªùi gian (ph√∫t)</label>
          <input type="number" id="duration" class="form-control" required>
        </div>

        <h5>C√¢u h·ªèi</h5>
        <div id="questionsContainer"></div>
        <button type="button" class="btn btn-outline-primary mb-3" onclick="addQuestion()">‚ûï Th√™m c√¢u h·ªèi</button>

        <button type="submit" class="btn btn-success w-100">‚úÖ T·∫°o ƒë·ªÅ thi</button>
      </form>
    </div>
  </div>

  <!-- K·∫øt qu·∫£ -->
  <h3>K·∫øt qu·∫£ thi</h3>
  <input type="text" id="examId" class="form-control mb-2" placeholder="Nh·∫≠p Exam ID ƒë·ªÉ xem k·∫øt qu·∫£">
  <button class="btn btn-info mb-3" onclick="loadResults()">üìä Xem k·∫øt qu·∫£</button>
  <div id="results"></div>
</div>

<script>
let questionIndex = 0;

function addQuestion() {
  const qId = "q" + Date.now();
  const container = document.createElement("div");
  container.classList.add("card", "p-3", "mb-3");
  container.innerHTML = `
    <div class="mb-2">
      <label>N·ªôi dung c√¢u h·ªèi</label>
      <input type="text" class="form-control question-text">
    </div>
    <div class="mb-2">
      <label>Lo·∫°i c√¢u h·ªèi</label>
      <select class="form-select question-type" onchange="renderOptions('${qId}', this.value)">
        <option value="tracnghiem">Tr·∫Øc nghi·ªám</option>
        <option value="truefalse">ƒê√∫ng / Sai</option>
        <option value="shortanswer">Tr·∫£ l·ªùi ng·∫Øn</option>
      </select>
    </div>
    <!-- üîë div r·ªóng ƒë·ªÉ render ƒë√°p √°n -->
    <div id="${qId}-options" class="mb-2"></div>
    <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">‚ùå X√≥a</button>
  `;
  document.getElementById("questionsContainer").appendChild(container);

  // render m·∫∑c ƒë·ªãnh tr·∫Øc nghi·ªám
  renderOptions(qId, "tracnghiem");
}


function renderOptions(qId, type) {
  // üîë ph·∫£i c√≥ d√≤ng n√†y ƒë·ªÉ l·∫•y div r·ªóng ra tr∆∞·ªõc
  const optionsDiv = document.getElementById(`${qId}-options`);

  if (type === "tracnghiem") {
    optionsDiv.innerHTML = `
      <label>Nh·∫≠p c√°c ƒë√°p √°n (√≠t nh·∫•t 2):</label>
      <div class="mb-2">
        <input type="text" class="form-control option-input" placeholder="ƒê√°p √°n 1">
      </div>
      <div class="mb-2">
        <input type="text" class="form-control option-input" placeholder="ƒê√°p √°n 2">
      </div>
      <div class="mb-2">
        <input type="text" class="form-control option-input" placeholder="ƒê√°p √°n 3 (t√πy ch·ªçn)">
      </div>
      <div class="mb-2">
        <input type="text" class="form-control option-input" placeholder="ƒê√°p √°n 4 (t√πy ch·ªçn)">
      </div>
      <input type="number" class="form-control correct-answer" placeholder="S·ªë th·ª© t·ª± ƒë√°p √°n ƒë√∫ng (1-4)">
    `;
  } else if (type === "truefalse") {
    optionsDiv.innerHTML = `
      <p>Ch·ªçn ƒë√°p √°n ƒë√∫ng:</p>
      <div class="form-check">
        <input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="0" checked>
        <label class="form-check-label">ƒê√∫ng</label>
      </div>
      <div class="form-check">
        <input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="1">
        <label class="form-check-label">Sai</label>
      </div>
    `;
  } else if (type === "shortanswer") {
    optionsDiv.innerHTML = `
      <label>ƒê√°p √°n chu·∫©n (c√≥ th·ªÉ b·ªè tr·ªëng ƒë·ªÉ ch·∫•m tay):</label>
      <input type="text" class="form-control correct-answer" placeholder="V√≠ d·ª•: H√† N·ªôi">
    `;
  }
}
// Submit form
document.getElementById("createExamForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const title = document.getElementById("title").value;
  const subject = document.getElementById("subject").value;
  const duration = parseInt(document.getElementById("duration").value);

  const questions = [];
  document.querySelectorAll("#questionsContainer .card").forEach(card => {
    const question = card.querySelector(".question-text").value;
    const type = card.querySelector(".question-type").value;

    let options = [];
    let correctAnswer = null;

    if (type === "tracnghiem") {
      options = Array.from(card.querySelectorAll(".option-input")).map(opt => opt.value).filter(v => v);
      correctAnswer = parseInt(card.querySelector(".correct-answer").value);
    } else if (type === "truefalse") {
      options = ["ƒê√∫ng", "Sai"];
      correctAnswer = parseInt(card.querySelector(".correct-answer:checked").value);
    } else if (type === "shortanswer") {
      correctAnswer = card.querySelector(".correct-answer").value || null;
    }

    questions.push({ question, type, options, correctAnswer });
  });

  let res = await fetch("/api/exams", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ title, subject, duration, questions })
  });
  let data = await res.json();
  if (data.exam) {
    alert("‚úÖ T·∫°o ƒë·ªÅ thi th√†nh c√¥ng! Exam ID: " + data.exam._id);
  } else {
    alert("‚ùå L·ªói: " + (data.message || "Kh√¥ng t·∫°o ƒë∆∞·ª£c ƒë·ªÅ thi"));
  }
});
// Load results
async function loadResults() {
  let examId = document.getElementById("examId").value;
  let res = await fetch(`/api/exams/${examId}/results`);
  let data = await res.json();

  let html = `
    <table class="table table-bordered">
      <thead><tr><th>H·ªçc sinh</th><th>ƒêi·ªÉm</th><th>B√†i t·ª± lu·∫≠n</th><th>Ch·∫•m</th></tr></thead>
      <tbody>`;
  data.forEach(r => {
    const shortAns = r.answers.filter(a => typeof a.answer === "string").map(a => `<li>${a.answer}</li>`).join("");
    html += `<tr>
      <td>${r.userId}</td>
      <td>${r.score ?? "-"}</td>
      <td><ul>${shortAns}</ul></td>
      <td><button class="btn btn-sm btn-primary" onclick="gradeResult('${r._id}')">Ch·∫•m</button></td>
    </tr>`;
  });
  html += "</tbody></table>";
  document.getElementById("results").innerHTML = html;
}

async function gradeResult(resultId) {
  let score = prompt("Nh·∫≠p ƒëi·ªÉm cho b√†i n√†y:");
  if (!score) return;
  let res = await fetch(`/api/results/${resultId}/grade`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ score: parseInt(score) })
  });
  let data = await res.json();
  alert("‚úÖ ƒê√£ ch·∫•m: " + data.result.score);
  loadResults();
}
</script>
</body>
</html>
