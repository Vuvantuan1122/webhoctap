<!DOCTYPE html>
<html lang="vi">
<head>
  
  <div class="header">
  <a href="index.html" class="logo">
    <img src="images/logo.png" alt="Logo">
  </a>
  <h1><i class="fa-solid fa-book"></i> ExamPro | Qu·∫£n l√Ω ƒë·ªÅ thi</h1>
</div>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-color: #6f42c1; /* M√†u t√≠m ch·ªß ƒë·∫°o */
      --primary-hover: #59359a;
      --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --card-radius: 0.75rem;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8f9fa;
    }
    
    .navbar {
        background: linear-gradient(90deg, var(--primary-color), #a98eda);
    }
    
    .nav-tabs .nav-link {
        font-weight: 500;
    }
    
    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        border-color: var(--primary-color) var(--primary-color) #fff;
    }
    
    .card {
        border: none;
        border-radius: var(--card-radius);
        box-shadow: var(--card-shadow);
        transition: transform 0.2s ease-in-out;
    }
    
    .card:hover {
        transform: translateY(-3px);
    }
    
    .btn-primary, .btn-success, .btn-info {
        transition: all 0.2s ease;
    }
    
    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: scale(1.03);
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    }

    /* Animation cho c√¢u h·ªèi */
    @keyframes slideDownFadeIn {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .question-card-new {
        animation: slideDownFadeIn 0.5s ease-out forwards;
    }
    
    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
            transform: scale(0.95);
        }
    }
    .question-card-removing {
        animation: fadeOut 0.4s ease-in forwards;
    }

  </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="message-box" class="hidden fixed top-5 right-5 z-50 px-6 py-3 rounded-lg text-white transition-opacity duration-300">
        <p id="message-text"></p>
    </div>


<body>
  
  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title"><i class="bi bi-card-checklist"></i> Chi ti·∫øt b√†i l√†m</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailBody"></div>
      </div>
    </div>
  </div>

  <nav class="navbar navbar-dark shadow-sm">
      <div class="container-fluid">
          <a class="navbar-brand" href="#">
              <i class="bi bi-journal-bookmark-fill"></i>
              <strong>ExamPro</strong> | Qu·∫£n l√Ω ƒë·ªÅ thi
          </a>
      </div>
  </nav>

  <main class="container py-5">
    
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-tab-pane" type="button" role="tab" aria-controls="create-tab-pane" aria-selected="true"><i class="bi bi-pencil-square"></i> T·∫°o ƒë·ªÅ thi</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-tab-pane" type="button" role="tab" aria-controls="results-tab-pane" aria-selected="false"><i class="bi bi-bar-chart-line-fill"></i> Xem k·∫øt qu·∫£</button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="create-tab-pane" role="tabpanel" aria-labelledby="create-tab" tabindex="0">
        <div class="card">
          <div class="card-body p-4">
            <h3 class="card-title mb-4 border-bottom pb-2">Th√¥ng tin ƒë·ªÅ thi</h3>
            <form id="createExamForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">T√™n ƒë·ªÅ thi</label>
                  <input type="text" id="title" class="form-control" required placeholder="V√≠ d·ª•: ƒê·ªÅ thi cu·ªëi k·ª≥ I">
                </div>
                <div class="col-md-3">
                  <label class="form-label">M√¥n h·ªçc</label>
                  <input type="text" id="subject" class="form-control" required placeholder="V√≠ d·ª•: To√°n h·ªçc">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Th·ªùi gian (ph√∫t)</label>
                  <input type="number" id="duration" class="form-control" required placeholder="V√≠ d·ª•: 90">
                </div>
                <div class="col-12">
                  <label class="form-label">ƒêo·∫°n vƒÉn ƒë·ªçc hi·ªÉu (n·∫øu c√≥)</label>
                  <textarea id="passage" class="form-control" rows="5" placeholder="Nh·∫≠p ƒëo·∫°n vƒÉn cho c√°c c√¢u h·ªèi ƒë·ªçc hi·ªÉu..."></textarea>
                </div>
              </div>
              
              <h4 class="mt-5 border-bottom pb-2 mb-4">Danh s√°ch c√¢u h·ªèi</h4>
              <div id="questionsContainer"></div>
              
              <button type="button" class="btn btn-outline-primary mb-4" onclick="addQuestion()"><i class="bi bi-plus-circle-dotted"></i> Th√™m c√¢u h·ªèi</button>
              
              <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold"><i class="bi bi-check-circle-fill"></i> Ho√†n t·∫•t v√† T·∫°o ƒë·ªÅ thi</button>
            </form>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="results-tab-pane" role="tabpanel" aria-labelledby="results-tab" tabindex="0">
        <div class="card">
            <div class="card-body p-4">
                <h3 class="card-title mb-4">Tra c·ª©u k·∫øt qu·∫£</h3>
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                    <input type="text" id="examId" class="form-control" placeholder="Nh·∫≠p Exam ID ƒë·ªÉ xem k·∫øt qu·∫£">
                    <button class="btn btn-info text-white" onclick="loadResults()"><i class="bi bi-search"></i> Xem ƒëi·ªÉm</button>
                    <button class="btn btn-warning text-dark" onclick="loadExitLogs()"><i class="bi bi-shield-exclamation"></i> Xem l·ªãch s·ª≠ tho√°t</button>
                </div>
                <div id="loadingSpinner" class="text-center my-4 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
                </div>
                <div id="exitLogs"></div>
                <div id="results"></div>
            </div>
        </div>
      </div>
    </div>
  </main>

<script>
let questionIndex = 0;

function addQuestion() {
  const qId = "q" + Date.now();
  const container = document.createElement("div");
  // Th√™m class animation
  container.classList.add("card", "p-3", "mb-3", "question-card-new"); 
  questionIndex++;
  
  container.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0 text-primary">C√¢u h·ªèi ${questionIndex}</h6>
      <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)">
        <i class="bi bi-trash3"></i> X√≥a
      </button>
    </div>
    <div class="mb-2">
      <label class="form-label">N·ªôi dung c√¢u h·ªèi</label>
      <input type="text" class="form-control question-text">
    </div>
    <div class="mb-2">
      <label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
      <select class="form-select question-type" onchange="renderOptions('${qId}', this.value)">
        <option value="tracnghiem">Tr·∫Øc nghi·ªám</option>
        <option value="truefalse">ƒê√∫ng / Sai</option>
        <option value="shortanswer">Tr·∫£ l·ªùi ng·∫Øn</option>
      </select>
    </div>
    <div id="${qId}-options" class="mb-2"></div>
  `;
  document.getElementById("questionsContainer").appendChild(container);
  renderOptions(qId, "tracnghiem");
}

function removeQuestion(button) {
    const card = button.closest('.card');
    card.classList.add('question-card-removing');
    // Ch·ªù animation ho√†n t·∫•t r·ªìi m·ªõi x√≥a element
    card.addEventListener('animationend', () => {
        card.remove();
        // C·∫≠p nh·∫≠t l·∫°i s·ªë th·ª© t·ª± c√¢u h·ªèi (t√πy ch·ªçn, n·∫øu mu·ªën)
    });
}


function renderOptions(qId, type) {
  const optionsDiv = document.getElementById(`${qId}-options`);
  optionsDiv.innerHTML = ''; // X√≥a n·ªôi dung c≈©

  if (type === "tracnghiem") {
    optionsDiv.innerHTML = `
      <label class="form-label">C√°c l·ª±a ch·ªçn v√† ƒë√°p √°n ƒë√∫ng:</label>
      <div class="row g-2">
        <div class="col-md-6"><input type="text" class="form-control option-input" placeholder="L·ª±a ch·ªçn 1"></div>
        <div class="col-md-6"><input type="text" class="form-control option-input" placeholder="L·ª±a ch·ªçn 2"></div>
        <div class="col-md-6"><input type="text" class="form-control option-input" placeholder="L·ª±a ch·ªçn 3 (t√πy ch·ªçn)"></div>
        <div class="col-md-6"><input type="text" class="form-control option-input" placeholder="L·ª±a ch·ªçn 4 (t√πy ch·ªçn)"></div>
      </div>
      <input type="number" class="form-control correct-answer mt-2" placeholder="Nh·∫≠p s·ªë th·ª© t·ª± ƒë√°p √°n ƒë√∫ng (1-4)" min="1" max="4">
      <div class="form-text">V√≠ d·ª•: n·∫øu l·ª±a ch·ªçn 2 l√† ƒë√∫ng, nh·∫≠p s·ªë 2.</div>
    `;
  } else if (type === "truefalse") {
    optionsDiv.innerHTML = `
      <p class="mb-1">Ch·ªçn ƒë√°p √°n ƒë√∫ng:</p>
      <div class="form-check form-check-inline">
        <input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="0" id="${qId}-true" checked>
        <label class="form-check-label" for="${qId}-true">ƒê√∫ng</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="1" id="${qId}-false">
        <label class="form-check-label" for="${qId}-false">Sai</label>
      </div>
    `;
  } else if (type === "shortanswer") {
    optionsDiv.innerHTML = `
      <label class="form-label">ƒê√°p √°n ƒë√∫ng</label>
      <input type="text" class="form-control correct-answer" placeholder="V√≠ d·ª•: H√† N·ªôi">
      <div class="form-text">B·∫°n c√≥ th·ªÉ b·ªè tr·ªëng ƒë·ªÉ ch·∫•m th·ªß c√¥ng sau.</div>
    `;
  }
}

document.getElementById("createExamForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const title = document.getElementById("title").value;
  const subject = document.getElementById("subject").value;
  const duration = parseInt(document.getElementById("duration").value);
  const passage = document.getElementById("passage").value;
  const questions = [];

  document.querySelectorAll("#questionsContainer .card").forEach(card => {
    const question = card.querySelector(".question-text").value;
    const type = card.querySelector(".question-type").value;
    let options = [];
    let correctAnswer = null;

    if (type === "tracnghiem") {
      options = Array.from(card.querySelectorAll(".option-input")).map(opt => opt.value).filter(v => v);
      correctAnswer = parseInt(card.querySelector(".correct-answer").value);
    } else if (type === "truefalse") {
      options = ["ƒê√∫ng", "Sai"];
      correctAnswer = parseInt(card.querySelector(".correct-answer:checked").value);
    } else if (type === "shortanswer") {
      correctAnswer = card.querySelector(".correct-answer").value || null;
    }
    questions.push({ question, type, options, correctAnswer });
  });

  try {
    let res = await fetch("/api/exams", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ title, subject, duration, passage, questions })
    });
    let data = await res.json();
    if (data.exam) {
      alert("‚úÖ T·∫°o ƒë·ªÅ thi th√†nh c√¥ng!\nExam ID: " + data.exam._id);
    } else {
      alert("‚ùå L·ªói: " + (data.message || "Kh√¥ng t·∫°o ƒë∆∞·ª£c ƒë·ªÅ thi"));
    }
  } catch (error) {
    alert("‚ùå ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.");
  }
});

async function loadResults() {
  let examId = document.getElementById("examId").value.trim();
  if (!examId) {
      alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p Exam ID!");
      return;
  }
  
  const spinner = document.getElementById("loadingSpinner");
  const resultsDiv = document.getElementById("results");
  const exitLogsDiv = document.getElementById("exitLogs");

  spinner.classList.remove("d-none");
  resultsDiv.innerHTML = "";
  exitLogsDiv.innerHTML = "";

  try {
    let res = await fetch(`/api/exams/${examId}/results`);
    let data = await res.json();
    let html = `
      <table class="table table-hover table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>H·ªçc sinh</th>
            <th>ƒêi·ªÉm</th>
            <th>Xem chi ti·∫øt</th>
            <th>Ch·∫•m ƒëi·ªÉm</th>
          </tr>
        </thead>
        <tbody>`;
    
    if (data.length === 0) {
        html += `<tr><td colspan="4" class="text-center">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o cho ƒë·ªÅ thi n√†y.</td></tr>`;
    } else {
        data.forEach(r => {
          html += `<tr>
            <td>${r.userId}</td>
            <td><span class="badge bg-primary fs-6">${r.score ?? "Ch∆∞a ch·∫•m"}</span></td>
            <td><button class="btn btn-sm btn-outline-info" onclick='viewDetail(${JSON.stringify(r)})'><i class="bi bi-eye"></i> Xem</button></td>
            <td><button class="btn btn-sm btn-primary" onclick="gradeResult('${r._id}')"><i class="bi bi-check2-circle"></i> Ch·∫•m</button></td>
          </tr>`;
        });
    }
    html += "</tbody></table>";
    resultsDiv.innerHTML = html;
  } catch (error) {
    resultsDiv.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£. Vui l√≤ng ki·ªÉm tra l·∫°i Exam ID.</div>`;
  } finally {
    spinner.classList.add("d-none");
  }
}

async function loadExitLogs() {
  let examId = document.getElementById("examId").value.trim();
  if (!examId) {
    alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p Exam ID!");
    return;
  }

  const spinner = document.getElementById("loadingSpinner");
  const exitLogsDiv = document.getElementById("exitLogs");
  const resultsDiv = document.getElementById("results");
  
  spinner.classList.remove("d-none");
  exitLogsDiv.innerHTML = "";
  resultsDiv.innerHTML = "";


  try {
    let res = await fetch(`/api/exams/${examId}/exit-log`);
    let logs = await res.json();

    if (!logs.length) {
      exitLogsDiv.innerHTML = "<div class='alert alert-success'><i class='bi bi-check-circle-fill'></i> Kh√¥ng c√≥ h·ªçc sinh n√†o tho√°t ra trong qu√° tr√¨nh l√†m b√†i.</div>";
      return;
    }

    let html = `
      <h5 class="mb-3"><i class="bi bi-file-earmark-text"></i> L·ªãch s·ª≠ tho√°t</h5>
      <div class="table-responsive">
      <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr><th>H·ªçc sinh</th><th>L√Ω do</th><th>Th·ªùi gian</th></tr>
        </thead>
        <tbody>`;
    
    logs.forEach(l => {
      const time = new Date(l.timestamp).toLocaleString("vi-VN");
      html += `
        <tr>
          <td>${l.userId}</td>
          <td><span class="badge bg-danger">${l.reason}</span></td>
          <td>${time}</td>
        </tr>`;
    });
    html += "</tbody></table></div>";
    exitLogsDiv.innerHTML = html;
  } catch (error) {
      exitLogsDiv.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ tho√°t. Vui l√≤ng ki·ªÉm tra l·∫°i Exam ID.</div>`;
  } finally {
      spinner.classList.add("d-none");
  }
}

function getStatusBadge(studentAnswer, correctAnswer, type, options) {
    if (type === 'shortanswer') {
        return `<span class="badge bg-warning text-dark">üìù GV Ch·∫•m</span>`;
    }
    if (studentAnswer === null || studentAnswer === undefined) {
        return `<span class="badge bg-secondary">Ch∆∞a tr·∫£ l·ªùi</span>`;
    }
    if (parseInt(studentAnswer) === parseInt(correctAnswer)) {
        return `<span class="badge bg-success">‚úÖ ƒê√∫ng</span>`;
    }
    return `<span class="badge bg-danger">‚ùå Sai</span>`;
}

function viewDetail(result) {
  let html = `<h5><i class="bi bi-person-fill"></i> H·ªçc sinh: <strong>${result.userId}</strong></h5>`;
  html += `<div class="table-responsive"><table class="table table-sm table-bordered">
    <thead class="table-light">
      <tr>
        <th>C√¢u</th>
        <th>C√¢u h·ªèi</th>
        <th>L·ª±a ch·ªçn c·ªßa HS</th>
        <th>ƒê√°p √°n ƒë√∫ng</th>
        <th>K·∫øt qu·∫£</th>
      </tr>
    </thead><tbody>`;

  result.answers.forEach((a, i) => {
    let studentAns, correct, status;

    if (a.type === "tracnghiem" || a.type === "truefalse") {
  const studentIndex = (a.answer !== null && a.answer !== undefined) ? parseInt(a.answer) : null;
  const correctIndex = (a.correctAnswer !== null && a.correctAnswer !== undefined) ? parseInt(a.correctAnswer) : null;

  studentAns = a.options?.[studentIndex] ?? "<i class='text-muted'>(kh√¥ng ch·ªçn)</i>";
  correct = a.options?.[correctIndex] ?? "-";
  status = (studentIndex !== null && studentIndex === correctIndex) ? "‚úÖ ƒê√∫ng" : "‚ùå Sai";
} else if (a.type === "shortanswer") {
  studentAns = (a.answer && a.answer.trim() !== "") ? a.answer : "<i class='text-muted'>(ch∆∞a tr·∫£ l·ªùi)</i>";
  correct = (typeof a.correctAnswer === "string" && a.correctAnswer.trim() !== "")
    ? a.correctAnswer
    : "<i class='text-muted'>(GV ch·∫•m)</i>";
  status = "üìù T·ª± lu·∫≠n (GV ch·∫•m)";
}
    
    status = getStatusBadge(a.answer, a.correctAnswer, a.type, a.options);
    
    html += `<tr>
      <td>${i+1}</td>
      <td>${a.question}</td>
      <td>${studentAns}</td>
      <td><strong>${correct}</strong></td>
      <td>${status}</td>
    </tr>`;
  });

  html += "</tbody></table></div>";

  document.getElementById("detailBody").innerHTML = html;
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

async function gradeResult(resultId) {
  let score = prompt("Nh·∫≠p ƒëi·ªÉm cho b√†i l√†m n√†y (thang 10):");
  if (score === null || score.trim() === "") return;

  const scoreValue = parseFloat(score);
  if (isNaN(scoreValue) || scoreValue < 0 || scoreValue > 10) {
      alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p m·ªôt s·ªë t·ª´ 0 ƒë·∫øn 10.");
      return;
  }

  try {
      let res = await fetch(`/api/results/${resultId}/grade`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ score: scoreValue })
      });
      let data = await res.json();
      if(res.ok) {
        alert("‚úÖ ƒê√£ ch·∫•m ƒëi·ªÉm th√†nh c√¥ng: " + data.result.score);
        loadResults();
      } else {
        alert("‚ùå L·ªói: " + (data.message || "Kh√¥ng th·ªÉ ch·∫•m ƒëi·ªÉm"));
      }
  } catch(error) {
      alert("‚ùå ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi.");
  }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>