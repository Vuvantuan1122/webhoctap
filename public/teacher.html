<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω ƒë·ªÅ thi Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary-color: #6f42c1;
    --primary-hover: #59359a;
    --card-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    --card-radius: 0.75rem;
    --transition-ease: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); /* Ease-in-out m∆∞·ª£t m√† */
  }

  body {
    font-family: 'Poppins', sans-serif;
    background-color: #f8f9fa;
    color: #333;
    overflow-x: hidden; /* NgƒÉn tr√†n ngang */
  }

  .navbar {
    background: linear-gradient(90deg, var(--primary-color), #a98eda);
    transition: var(--transition-ease);
  }

  .navbar:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* Hi·ªáu ·ª©ng shadow khi hover navbar */
  }

  .nav-tabs .nav-link {
    font-weight: 500;
    padding: 0.75rem 1.5rem;
    transition: var(--transition-ease);
    position: relative;
  }

  .nav-tabs .nav-link:hover {
    background-color: rgba(111, 66, 193, 0.1); /* Hi·ªáu ·ª©ng hover nh·∫π */
  }

  .nav-tabs .nav-link.active {
    color: var(--primary-color);
    border-color: var(--primary-color) var(--primary-color) #fff;
    position: relative;
  }

  .nav-tabs .nav-link.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--primary-color);
    animation: slideIn 0.3s ease-in-out; /* Hi·ªáu ·ª©ng tr∆∞·ª£t khi tab active */
  }

  @keyframes slideIn {
    from { width: 0; }
    to { width: 100%; }
  }

  .container {
    max-width: 1200px;
  }

  .card {
    border: none;
    border-radius: var(--card-radius);
    box-shadow: var(--card-shadow);
    transition: var(--transition-ease);
    margin-bottom: 1.5rem;
    transform: translateY(0);
    opacity: 1;
  }

  .card:hover {
    transform: translateY(-5px); /* N√¢ng card nh·∫π khi hover */
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* TƒÉng shadow khi hover */
  }

  .card-body {
    padding: 2rem;
  }

  .btn-primary, .btn-success, .btn-info, .btn-warning, .btn-outline-danger {
    transition: var(--transition-ease);
    padding: 0.6rem 1.5rem;
    border-radius: 0.5rem;
  }

  .btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }

  .btn-primary:hover, .btn-success:hover, .btn-info:hover, .btn-warning:hover {
    transform: translateY(-2px); /* N√¢ng nh·∫π button khi hover */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .btn-primary:hover {
    background-color: var(--primary-hover);
    border-color: var(--primary-hover);
  }

  .form-control, .form-select {
    padding: 0.75rem;
    border-radius: 0.5rem;
    transition: var(--transition-ease);
  }

  .form-control:focus, .form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
    transform: scale(1.01); /* Ph√≥ng nh·∫π khi focus */
  }

  .form-label {
    margin-bottom: 0.5rem;
    font-weight: 500;
  }

  .form-check {
    margin-bottom: 0.75rem;
    transition: var(--transition-ease);
  }

  .form-check-label {
    margin-left: 0.5rem;
    transition: color 0.2s ease;
  }

  .form-check-input:checked + .form-check-label {
    color: var(--primary-color); /* ƒê·ªïi m√†u label khi checkbox ƒë∆∞·ª£c ch·ªçn */
  }

  /* Hi·ªáu ·ª©ng cho card c√¢u h·ªèi m·ªõi */
  .question-card-new {
    animation: slideDownFadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  @keyframes slideDownFadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .question-card-removing {
    animation: fadeOut 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
  }

  @keyframes fadeOut {
    from { opacity: 1; transform: scale(1); }
    to { opacity: 0; transform: scale(0.95); }
  }

  /* Hi·ªáu ·ª©ng cho modal */
  .modal-content {
    border-radius: var(--card-radius);
    transform: scale(0.9);
    opacity: 0;
    transition: var(--transition-ease);
  }

  .modal.show .modal-content {
    transform: scale(1);
    opacity: 1;
  }

  /* TƒÉng kho·∫£ng c√°ch trong container c√¢u h·ªèi */
  #questionsContainer .card {
    margin-bottom: 1.5rem;
  }

  #questionsContainer .card-body {
    padding: 1.5rem;
  }

  /* TƒÉng kho·∫£ng c√°ch trong checkbox l·ªõp h·ªçc */
  #classroomCheckboxes .form-check {
    margin-right: 1rem;
  }

  /* Tinh ch·ªânh b·∫£ng k·∫øt qu·∫£ */
  .table {
    margin-top: 1rem;
    border-collapse: separate;
    border-spacing: 0 0.75rem;
    background-color: #fff;
    border-radius: var(--card-radius);
    overflow: hidden;
  }

  .table th, .table td {
    padding: 0.75rem 1.25rem;
    vertical-align: middle;
    transition: var(--transition-ease);
  }

  .table tbody tr {
    transition: var(--transition-ease);
  }

  .table tbody tr:hover {
    background-color: rgba(111, 66, 193, 0.05); /* Hi·ªáu ·ª©ng hover nh·∫π cho d√≤ng b·∫£ng */
    transform: translateX(5px); /* D·ªãch nh·∫π sang ph·∫£i khi hover */
  }

  /* Hi·ªáu ·ª©ng loading spinner */
  .spinner-border {
    animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    border-width: 0.3rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  #loadingSpinner p {
    transition: opacity 0.3s ease;
  }

  /* Hi·ªáu ·ª©ng cho message box */
  #message-box {
    transition: opacity 0.5s ease, transform 0.5s ease;
    transform: translateX(20px);
  }

  #message-box.show {
    transform: translateX(0);
    opacity: 1;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .card-body {
      padding: 1.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
    }

    .form-control, .form-select {
      padding: 0.5rem;
    }

    .table th, .table td {
      padding: 0.5rem 0.75rem;
    }

    .nav-tabs .nav-link {
      padding: 0.5rem 1rem;
    }

    .modal-content {
      transform: scale(0.95); /* Gi·∫£m scale tr√™n mobile ƒë·ªÉ tr√°nh tr√†n */
    }

    .modal.show .modal-content {
      transform: scale(1);
    }
  }
</style>
</head>
<body class="bg-gray-900 text-white antialiased">
  <div id="message-box" class="hidden fixed top-5 right-5 z-50 px-6 py-3 rounded-lg text-white transition-opacity duration-300">
    <p id="message-text"></p>
  </div>

  <div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title"><i class="bi bi-card-checklist"></i> Chi ti·∫øt b√†i l√†m</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="detailBody"></div>
      </div>
    </div>
  </div>

  <nav class="navbar navbar-dark shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="bi bi-journal-bookmark-fill"></i>
        <strong>ExamPro</strong> | Qu·∫£n l√Ω ƒë·ªÅ thi
      </a>
    </div>
  </nav>

  <main class="container py-5">
    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-tab-pane" type="button" role="tab" aria-controls="create-tab-pane" aria-selected="true"><i class="bi bi-pencil-square"></i> T·∫°o ƒë·ªÅ thi</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-tab-pane" type="button" role="tab" aria-controls="results-tab-pane" aria-selected="false"><i class="bi bi-bar-chart-line-fill"></i> Xem k·∫øt qu·∫£</button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="create-tab-pane" role="tabpanel" aria-labelledby="create-tab" tabindex="0">
        <div class="card">
          <div class="card-body p-4">
            <h3 class="card-title mb-4 border-bottom pb-2">Th√¥ng tin ƒë·ªÅ thi</h3>
            <form id="createExamForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">T√™n ƒë·ªÅ thi</label>
                  <input type="text" id="title" class="form-control" required placeholder="V√≠ d·ª•: ƒê·ªÅ thi cu·ªëi k·ª≥ I">
                </div>
                <div class="col-md-3">
                  <label class="form-label">M√¥n h·ªçc</label>
                  <input type="text" id="subject" class="form-control" required placeholder="V√≠ d·ª•: To√°n h·ªçc">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Th·ªùi gian (ph√∫t)</label>
                  <input type="number" id="duration" class="form-control" required placeholder="V√≠ d·ª•: 90">
                </div>
                <div class="col-12">
                  <label class="form-label">ƒêo·∫°n vƒÉn ƒë·ªçc hi·ªÉu (n·∫øu c√≥)</label>
                  <textarea id="passage" class="form-control" rows="5" placeholder="Nh·∫≠p ƒëo·∫°n vƒÉn cho c√°c c√¢u h·ªèi ƒë·ªçc hi·ªÉu..."></textarea>
                </div>
                <div class="col-12 mt-4">
                  <label class="form-label fw-bold"><i class="bi bi-people-fill me-2"></i>Ph√¢n b·ªï cho l·ªõp h·ªçc (B·∫Øt bu·ªôc ch·ªçn)</label>
                  <div id="classroomCheckboxes" class="border p-3 rounded bg-light">
                    <div class="text-center text-muted" id="classroomLoading">ƒêang t·∫£i danh s√°ch l·ªõp h·ªçc...</div>
                  </div>
                </div>
                <div class="col-12 mt-3">
                  <label class="form-label">Import c√¢u h·ªèi t·ª´ file Word (.docx)</label>
                  <input type="file" id="importFile" accept=".docx" class="form-control">
                  <small class="form-text text-muted">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng: <br>- Tr·∫Øc nghi·ªám: C√¢u 1: N·ªôi dung? A. Opt1 B. Opt2 C. Opt3 D. Opt4<br>- ƒê√∫ng/Sai: C√¢u 1: N·ªôi dung? A. ƒê√∫ng B. Sai<br>- Tr·∫£ l·ªùi ng·∫Øn: C√¢u 1: N·ªôi dung? (T·ª± lu·∫≠n) ƒê√°p √°n: text<br>Sau khi import, ch·ªçn ƒë√°p √°n ƒë√∫ng.</small>
                  <button type="button" class="btn btn-secondary mt-2" onclick="importQuestions()"><i class="bi bi-upload"></i> Import</button>
                </div>
              </div>
              
              <h4 class="mt-5 border-bottom pb-2 mb-4">Danh s√°ch c√¢u h·ªèi</h4>
              <div id="questionsContainer"></div>
              
              <button type="button" class="btn btn-outline-primary mb-4" onclick="addQuestion()"><i class="bi bi-plus-circle-dotted"></i> Th√™m c√¢u h·ªèi</button>
              
              <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold"><i class="bi bi-check-circle-fill"></i> Ho√†n t·∫•t v√† T·∫°o ƒë·ªÅ thi</button>
            </form>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="results-tab-pane" role="tabpanel" aria-labelledby="results-tab" tabindex="0">
        <div class="card">
          <div class="card-body p-4">
            <h3 class="card-title mb-4">Tra c·ª©u k·∫øt qu·∫£</h3>
            <div class="input-group mb-3">
              <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
              <input type="text" id="examId" class="form-control" placeholder="Nh·∫≠p Exam ID ƒë·ªÉ xem k·∫øt qu·∫£">
              <button class="btn btn-info text-white" onclick="loadResults()"><i class="bi bi-search"></i> Xem ƒëi·ªÉm</button>
              <button class="btn btn-warning text-dark" onclick="loadExitLogs()"><i class="bi bi-shield-exclamation"></i> Xem l·ªãch s·ª≠ tho√°t</button>
            </div>
            <button class="btn btn-success mb-3" onclick="loadAllResults()">
              <i class="bi bi-collection"></i> Xem t·∫•t c·∫£ k·∫øt qu·∫£
            </button>
            <div id="loadingSpinner" class="text-center my-4 d-none">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>
            <div id="exitLogs"></div>
            <div id="results"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script>
    let questionIndex = 0;
    let teacherClassrooms = [];

    async function loadTeacherClassrooms() {
      try {
        const res = await fetch("/api/classrooms/my");
        if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i danh s√°ch l·ªõp h·ªçc.");
        teacherClassrooms = await res.json();

        const container = document.getElementById("classroomCheckboxes");
        container.innerHTML = "";

        if (teacherClassrooms.length === 0) {
          container.innerHTML = "<div class='alert alert-warning mb-0'>‚ö†Ô∏è B·∫°n ch∆∞a t·∫°o/qu·∫£n l√Ω l·ªõp h·ªçc n√†o. Vui l√≤ng t·∫°o l·ªõp tr∆∞·ªõc.</div>";
          return;
        }

        teacherClassrooms.forEach(cls => {
          container.innerHTML += `
            <div class="form-check form-check-inline">
              <input class="form-check-input classroom-checkbox" type="checkbox" id="class-${cls._id}" value="${cls._id}">
              <label class="form-check-label" for="class-${cls._id}">
                ${cls.name} <span class="text-muted">(${cls.students.length} HS)</span>
              </label>
            </div>
          `;
        });
      } catch (error) {
        console.error("L·ªói khi t·∫£i l·ªõp h·ªçc:", error);
        document.getElementById("classroomCheckboxes").innerHTML = "<div class='alert alert-danger mb-0'>‚ùå L·ªói khi t·∫£i danh s√°ch l·ªõp h·ªçc.</div>";
      }
    }

    function addQuestion() {
      const qId = "q" + Date.now();
      const container = document.createElement("div");
      container.classList.add("card", "p-3", "mb-3", "question-card-new");
      questionIndex++;
      
      container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0 text-primary">C√¢u h·ªèi ${questionIndex}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)">
            <i class="bi bi-trash3"></i> X√≥a
          </button>
        </div>
        <div class="mb-2">
          <label class="form-label">N·ªôi dung c√¢u h·ªèi</label>
          <input type="text" class="form-control question-text">
        </div>
        <div class="mb-2">
          <label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
          <select class="form-select question-type" onchange="renderOptions('${qId}', this.value)">
            <option value="tracnghiem">Tr·∫Øc nghi·ªám</option>
            <option value="truefalse">ƒê√∫ng / Sai</option>
            <option value="shortanswer">Tr·∫£ l·ªùi ng·∫Øn</option>
          </select>
        </div>
        <div id="${qId}-options" class="mb-2"></div>
      `;
      document.getElementById("questionsContainer").appendChild(container);
      renderOptions(qId, "tracnghiem");
    }

    function removeQuestion(button) {
      const card = button.closest('.card');
      card.classList.add('question-card-removing');
      card.addEventListener('animationend', () => {
        card.remove();
      });
    }

    function renderOptions(qId, type) {
      const optionsDiv = document.getElementById(`${qId}-options`);
      optionsDiv.innerHTML = '';

      if (type === "tracnghiem") {
        optionsDiv.innerHTML = `
          <label class="form-label">C√°c l·ª±a ch·ªçn v√† ƒë√°p √°n ƒë√∫ng:</label>
          <div class="row g-2">
            <div class="col-md-6 d-flex align-items-center">
              <span class="me-2 fw-bold">A.</span>
              <input type="text" class="form-control option-input" placeholder="L·ª±a ch·ªçn 1">
            </div>
            <div class="col-md-6 d-flex align-items-center">
              <span class="me-2 fw-bold">B.</span>
              <input type="text" class="form-control option-input" placeholder="L·ª±a ch·ªçn 2">
            </div>
            <div class="col-md-6 d-flex align-items-center">
              <span class="me-2 fw-bold">C.</span>
              <input type="text" class="form-control option-input" placeholder="L·ª±a ch·ªçn 3 (t√πy ch·ªçn)">
            </div>
            <div class="col-md-6 d-flex align-items-center">
              <span class="me-2 fw-bold">D.</span>
              <input type="text" class="form-control option-input" placeholder="L·ª±a ch·ªçn 4 (t√πy ch·ªçn)">
            </div>
          </div>
          <select class="form-select correct-answer mt-2" required>
            <option value="" disabled selected>Ch·ªçn ƒë√°p √°n ƒë√∫ng (A, B, C, D)</option>
            <option value="0">A</option>
            <option value="1">B</option>
            <option value="2">C</option>
            <option value="3">D</option>
          </select>
          <div class="form-text">Ch·ªçn k√Ω t·ª± t∆∞∆°ng ·ª©ng v·ªõi ƒë√°p √°n ƒë√∫ng (A, B, C, D).</div>
        `;
      } else if (type === "truefalse") {
        optionsDiv.innerHTML = `
          <label class="form-label">C√°c l·ª±a ch·ªçn v√† ƒë√°p √°n ƒë√∫ng:</label>
          <div class="row g-2">
            <div class="col-md-6 d-flex align-items-center">
              <span class="me-2 fw-bold">A.</span>
              <div class="form-check">
                <input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="0" id="${qId}-true" checked>
                <label class="form-check-label" for="${qId}-true">ƒê√∫ng</label>
              </div>
            </div>
            <div class="col-md-6 d-flex align-items-center">
              <span class="me-2 fw-bold">B.</span>
              <div class="form-check">
                <input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="1" id="${qId}-false">
                <label class="form-check-label" for="${qId}-false">Sai</label>
              </div>
            </div>
          </div>
          <div class="form-text">Ch·ªçn ƒë√°p √°n ƒë√∫ng (A=ƒê√∫ng, B=Sai).</div>
        `;
      } else if (type === "shortanswer") {
        optionsDiv.innerHTML = `
          <label class="form-label">ƒê√°p √°n ƒë√∫ng</label>
          <input type="text" class="form-control correct-answer" placeholder="V√≠ d·ª•: H√† N·ªôi">
          <div class="form-text">B·∫°n c√≥ th·ªÉ b·ªè tr·ªëng ƒë·ªÉ ch·∫•m th·ªß c√¥ng sau.</div>
        `;
      }
    }

    document.getElementById("createExamForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const subject = document.getElementById("subject").value;
      const duration = parseInt(document.getElementById("duration").value);
      const passage = document.getElementById("passage").value;
      
      const selectedClassrooms = Array.from(document.querySelectorAll(".classroom-checkbox:checked")).map(cb => cb.value);

      if (selectedClassrooms.length === 0) {
        alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt l·ªõp h·ªçc ƒë·ªÉ ph√¢n b·ªï ƒë·ªÅ thi!");
        return;
      }
      
      const questions = [];

      document.querySelectorAll("#questionsContainer .card").forEach(card => {
        const question = card.querySelector(".question-text").value;
        const type = card.querySelector(".question-type").value;
        let options = [];
        let correctAnswer = null;

        if (type === "tracnghiem") {
          options = Array.from(card.querySelectorAll(".option-input")).map(opt => opt.value).filter(v => v);
          correctAnswer = parseInt(card.querySelector(".correct-answer").value);
        } else if (type === "truefalse") {
          options = ["ƒê√∫ng", "Sai"];
          correctAnswer = parseInt(card.querySelector(".correct-answer:checked").value);
        } else if (type === "shortanswer") {
          correctAnswer = card.querySelector(".correct-answer").value || null;
        }
        questions.push({ question, type, options, correctAnswer });
      });

      try {
        let res = await fetch("/api/exams", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            title, 
            subject, 
            duration, 
            passage, 
            questions,
            classrooms: selectedClassrooms
          })
        });
        let data = await res.json();
        if (data.exam) {
          alert("‚úÖ T·∫°o ƒë·ªÅ thi th√†nh c√¥ng!\nExam ID: " + data.exam._id);
        } else {
          alert("‚ùå L·ªói: " + (data.message || "Kh√¥ng t·∫°o ƒë∆∞·ª£c ƒë·ªÅ thi"));
        }
      } catch (error) {
        alert("‚ùå ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.");
      }
    });

    async function loadResults() {
      let examId = document.getElementById("examId").value.trim();
      if (!examId) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p Exam ID!");
        return;
      }
      
      const spinner = document.getElementById("loadingSpinner");
      const resultsDiv = document.getElementById("results");
      const exitLogsDiv = document.getElementById("exitLogs");

      spinner.classList.remove("d-none");
      resultsDiv.innerHTML = "";
      exitLogsDiv.innerHTML = "";

      try {
        let res = await fetch(`/api/exams/${examId}/results`);
        let data = await res.json();
        let html = `
          <table class="table table-hover table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>H·ªçc sinh</th>
                <th>ƒêi·ªÉm</th>
                <th>Xem chi ti·∫øt</th>
                <th>Ch·∫•m ƒëi·ªÉm</th>
              </tr>
            </thead>
            <tbody>`;
        
        if (data.length === 0) {
          html += `<tr><td colspan="4" class="text-center">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o cho ƒë·ªÅ thi n√†y.</td></tr>`;
        } else {
          data.forEach(r => {
            html += `<tr>
              <td>${r.userId}</td>
              <td><span class="badge bg-primary fs-6">${r.score ?? "Ch∆∞a ch·∫•m"}</span></td>
              <td><button class="btn btn-sm btn-outline-info" onclick='viewDetail(${JSON.stringify(r)})'><i class="bi bi-eye"></i> Xem</button></td>
              <td><button class="btn btn-sm btn-primary" onclick="gradeResult('${r._id}')"><i class="bi bi-check2-circle"></i> Ch·∫•m</button></td>
            </tr>`;
          });
        }
        html += "</tbody></table>";
        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£. Vui l√≤ng ki·ªÉm tra l·∫°i Exam ID.</div>`;
      } finally {
        spinner.classList.add("d-none");
      }
    }

    async function loadAllResults() {
      const resultsDiv = document.getElementById("results");
      const exitLogsDiv = document.getElementById("exitLogs");
      const spinner = document.getElementById("loadingSpinner");

      spinner.classList.remove("d-none");
      resultsDiv.innerHTML = "";
      exitLogsDiv.innerHTML = "";

      try {
        let res = await fetch("/api/results");
        let data = await res.json();

        if (!data.length) {
          resultsDiv.innerHTML = "<div class='alert alert-info'>Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o.</div>";
          return;
        }

        let html = `<table class="table table-hover table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>H·ªçc sinh</th>
              <th>ƒê·ªÅ thi</th>
              <th>M√¥n h·ªçc</th>
              <th>ƒêi·ªÉm</th>
              <th>Ng√†y n·ªôp</th>
              <th>Xem chi ti·∫øt</th>
            </tr>
          </thead>
          <tbody>`;

        data.forEach(r => {
          const time = new Date(r.createdAt).toLocaleString("vi-VN");
          html += `<tr>
            <td>${r.userId}</td>
            <td>${r.examId?.title || "-"}</td>
            <td>${r.examId?.subject || "-"}</td>
            <td><span class="badge bg-primary fs-6">${r.score ?? "Ch∆∞a ch·∫•m"}</span></td>
            <td>${time}</td>
            <td><button class="btn btn-sm btn-outline-info" onclick='viewDetail(${JSON.stringify(r)})'>
              <i class="bi bi-eye"></i> Xem</button></td>
          </tr>`;
        });

        html += "</tbody></table>";
        resultsDiv.innerHTML = html;
      } catch (error) {
        resultsDiv.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i t·∫•t c·∫£ k·∫øt qu·∫£.</div>`;
      } finally {
        spinner.classList.add("d-none");
      } 
    }

    async function loadExitLogs() {
      let examId = document.getElementById("examId").value.trim();
      if (!examId) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p Exam ID!");
        return;
      }

      const spinner = document.getElementById("loadingSpinner");
      const exitLogsDiv = document.getElementById("exitLogs");
      const resultsDiv = document.getElementById("results");
      
      spinner.classList.remove("d-none");
      exitLogsDiv.innerHTML = "";
      resultsDiv.innerHTML = "";

      try {
        let res = await fetch(`/api/exams/${examId}/exit-log`);
        let logs = await res.json();

        if (!logs.length) {
          exitLogsDiv.innerHTML = "<div class='alert alert-success'><i class='bi bi-check-circle-fill'></i> Kh√¥ng c√≥ h·ªçc sinh n√†o tho√°t ra trong qu√° tr√¨nh l√†m b√†i.</div>";
          return;
        }

        let html = `
          <h5 class="mb-3"><i class="bi bi-file-earmark-text"></i> L·ªãch s·ª≠ tho√°t</h5>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-light">
                <tr><th>H·ªçc sinh</th><th>L√Ω do</th><th>Th·ªùi gian</th></tr>
              </thead>
              <tbody>`;
        
        logs.forEach(l => {
          const time = new Date(l.timestamp).toLocaleString("vi-VN");
          html += `
            <tr>
              <td>${l.userId}</td>
              <td><span class="badge bg-danger">${l.reason}</span></td>
              <td>${time}</td>
            </tr>`;
        });
        html += "</tbody></table></div>";
        exitLogsDiv.innerHTML = html;
      } catch (error) {
        exitLogsDiv.innerHTML = `<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ tho√°t. Vui l√≤ng ki·ªÉm tra l·∫°i Exam ID.</div>`;
      } finally {
        spinner.classList.add("d-none");
      }
    }

    function getStatusBadge(studentAnswer, correctAnswer, type, options) {
      if (type === 'shortanswer') {
        return `<span class="badge bg-warning text-dark">üìù GV Ch·∫•m</span>`;
      }
      if (studentAnswer === null || studentAnswer === undefined) {
        return `<span class="badge bg-secondary">Ch∆∞a tr·∫£ l·ªùi</span>`;
      }
      if (parseInt(studentAnswer) === parseInt(correctAnswer)) {
        return `<span class="badge bg-success">‚úÖ ƒê√∫ng</span>`;
      }
      return `<span class="badge bg-danger">‚ùå Sai</span>`;
    }

    function viewDetail(result) {
      let html = `<h5><i class="bi bi-person-fill"></i> H·ªçc sinh: <strong>${result.userId}</strong></h5>`;
      html += `<div class="table-responsive"><table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th>C√¢u</th>
            <th>C√¢u h·ªèi</th>
            <th>L·ª±a ch·ªçn c·ªßa HS</th>
            <th>ƒê√°p √°n ƒë√∫ng</th>
            <th>K·∫øt qu·∫£</th>
          </tr>
        </thead><tbody>`;

      result.answers.forEach((a, i) => {
        let studentAns, correct, status;

        if (a.type === "tracnghiem" || a.type === "truefalse") {
          const studentIndex = (a.answer !== null && a.answer !== undefined) ? parseInt(a.answer) : null;
          const correctIndex = (a.correctAnswer !== null && a.correctAnswer !== undefined) ? parseInt(a.correctAnswer) : null;
          studentAns = a.options?.[studentIndex] ?? "<i class='text-muted'>(kh√¥ng ch·ªçn)</i>";
          correct = a.options?.[correctIndex] ?? "-";
          status = (studentIndex !== null && studentIndex === correctIndex) ? "‚úÖ ƒê√∫ng" : "‚ùå Sai";
        } else if (a.type === "shortanswer") {
          const ansText = (a.answer !== null && a.answer !== undefined) ? String(a.answer) : "";
          const correctText = (a.correctAnswer !== null && a.correctAnswer !== undefined) ? String(a.correctAnswer) : "";
          studentAns = ansText.trim() !== "" ? ansText : "<i class='text-muted'>(ch∆∞a tr·∫£ l·ªùi)</i>";
          correct = correctText.trim() !== "" ? correctText : "<i class='text-muted'>(GV ch·∫•m)</i>";
          status = "üìù T·ª± lu·∫≠n (GV ch·∫•m)";
        }
        
        status = getStatusBadge(a.answer, a.correctAnswer, a.type, a.options);
        
        html += `<tr>
          <td>${i+1}</td>
          <td>${a.question}</td>
          <td>${studentAns}</td>
          <td><strong>${correct}</strong></td>
          <td>${status}</td>
        </tr>`;
      });

      html += "</tbody></table></div>";
      document.getElementById("detailBody").innerHTML = html;
      new bootstrap.Modal(document.getElementById('detailModal')).show();
    }

    async function gradeResult(resultId) {
      let score = prompt("Nh·∫≠p ƒëi·ªÉm cho b√†i l√†m n√†y (thang 10):");
      if (score === null || score.trim() === "") return;

      const scoreValue = parseFloat(score);
      if (isNaN(scoreValue) || scoreValue < 0 || scoreValue > 10) {
        alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p m·ªôt s·ªë t·ª´ 0 ƒë·∫øn 10.");
        return;
      }

      try {
        let res = await fetch(`/api/results/${resultId}/grade`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ score: scoreValue })
        });
        let data = await res.json();
        if (res.ok) {
          alert("‚úÖ ƒê√£ ch·∫•m ƒëi·ªÉm th√†nh c√¥ng: " + data.result.score);
          loadResults();
        } else {
          alert("‚ùå L·ªói: " + (data.message || "Kh√¥ng th·ªÉ ch·∫•m ƒëi·ªÉm"));
        }
      } catch (error) {
        alert("‚ùå ƒê√£ x·∫£y ra l·ªói k·∫øt n·ªëi.");
      }
    }

    function importQuestions() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      if (!file) {
        alert('‚ö†Ô∏è Vui l√≤ng ch·ªçn file .docx!');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const arrayBuffer = e.target.result;
        mammoth.extractRawText({arrayBuffer: arrayBuffer})
          .then(function(result) {
            const text = result.value;
            parseAndAddQuestions(text);
          })
          .catch(function(err) {
            console.error('L·ªói ƒë·ªçc file:', err);
            alert('‚ùå L·ªói khi ƒë·ªçc file .docx. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng.');
          });
      };
      reader.readAsArrayBuffer(file);
    }

    function parseAndAddQuestions(text) {
      const lines = text.split('\n').filter(line => line.trim());
      let currentQuestion = null;

      lines.forEach((line, index) => {
        const trimmed = line.trim();
        if (trimmed.match(/^C√¢u \d+:/i)) {
          if (currentQuestion) {
            addImportedQuestion(currentQuestion);
          }
          const questionText = trimmed.replace(/^C√¢u \d+:/i, '').trim();
          const isTrueFalse = questionText.match(/ƒê√∫ng hay Sai\??$/i) || questionText.match(/True or False\??$/i);
          const isShortAnswer = questionText.match(/\(T·ª± lu·∫≠n\)$/i) || questionText.match(/\(Tr·∫£ l·ªùi ng·∫Øn\)$/i);
          currentQuestion = {
            question: questionText.replace(/\(T·ª± lu·∫≠n\)$/i, '').replace(/\(Tr·∫£ l·ªùi ng·∫Øn\)$/i, '').trim(),
            options: [],
            type: isTrueFalse ? 'truefalse' : isShortAnswer ? 'shortanswer' : 'tracnghiem',
            correctAnswer: null
          };
        } else if (currentQuestion && currentQuestion.type === 'tracnghiem' && trimmed.match(/^[A-D]\./i)) {
          currentQuestion.options.push(trimmed.replace(/^[A-D]\./i, '').trim());
        } else if (currentQuestion && currentQuestion.type === 'truefalse' && trimmed.match(/^[A-B]\./i)) {
          const optionText = trimmed.replace(/^[A-B]\./i, '').trim();
          if (optionText.match(/^ƒê√∫ng$/i) || optionText.match(/^True$/i) || optionText.match(/^Sai$/i) || optionText.match(/^False$/i)) {
            currentQuestion.options.push(optionText);
          }
        } else if (currentQuestion && currentQuestion.type === 'shortanswer' && trimmed.match(/^ƒê√°p √°n:/i)) {
          currentQuestion.correctAnswer = trimmed.replace(/^ƒê√°p √°n:/i, '').trim() || null;
        }
      });

      if (currentQuestion) {
        if (currentQuestion.type === 'tracnghiem' && currentQuestion.options.length >= 2) {
          addImportedQuestion(currentQuestion);
        } else if (currentQuestion.type === 'truefalse' && currentQuestion.options.length === 2 && 
                   currentQuestion.options[0].match(/^ƒê√∫ng$/i) && currentQuestion.options[1].match(/^Sai$/i)) {
          addImportedQuestion(currentQuestion);
        } else if (currentQuestion.type === 'shortanswer') {
          addImportedQuestion(currentQuestion);
        }
      }

      if (questionIndex === 0) {
        alert('‚ùå Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi n√†o trong file. ƒê·∫£m b·∫£o ƒë·ªãnh d·∫°ng ƒë√∫ng.');
      } else {
        alert(`‚úÖ ƒê√£ import th√†nh c√¥ng ${questionIndex} c√¢u h·ªèi. Vui l√≤ng ch·ªçn ƒë√°p √°n ƒë√∫ng cho Tr·∫Øc nghi·ªám v√† ƒê√∫ng/Sai.`);
      }
    }

    function addImportedQuestion(q) {
      const qId = "q" + Date.now();
      const container = document.createElement("div");
      container.classList.add("card", "p-3", "mb-3", "question-card-new");
      questionIndex++;

      let optionsHtml = '';
      if (q.type === 'tracnghiem') {
        optionsHtml = q.options.map((opt, index) => `
          <div class="col-md-6 d-flex align-items-center">
            <span class="me-2 fw-bold">${String.fromCharCode(65 + index)}.</span>
            <input type="text" class="form-control option-input" value="${opt}" readonly>
          </div>
        `).join('');
      } else if (q.type === 'truefalse') {
        optionsHtml = `
          <div class="col-md-6 d-flex align-items-center">
            <span class="me-2 fw-bold">A.</span>
            <div class="form-check">
              <input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="0" id="${qId}-true" checked>
              <label class="form-check-label" for="${qId}-true">ƒê√∫ng</label>
            </div>
          </div>
          <div class="col-md-6 d-flex align-items-center">
            <span class="me-2 fw-bold">B.</span>
            <div class="form-check">
              <input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="1" id="${qId}-false">
              <label class="form-check-label" for="${qId}-false">Sai</label>
            </div>
          </div>
        `;
      } else if (q.type === 'shortanswer') {
        optionsHtml = `
          <label class="form-label">ƒê√°p √°n ƒë√∫ng</label>
          <input type="text" class="form-control correct-answer" value="${q.correctAnswer || ''}" readonly>
          <div class="form-text">B·∫°n c√≥ th·ªÉ b·ªè tr·ªëng ƒë·ªÉ ch·∫•m th·ªß c√¥ng sau.</div>
        `;
      }

      container.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0 text-primary">C√¢u h·ªèi ${questionIndex}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)">
            <i class="bi bi-trash3"></i> X√≥a
          </button>
        </div>
        <div class="mb-2">
          <label class="form-label">N·ªôi dung c√¢u h·ªèi</label>
          <input type="text" class="form-control question-text" value="${q.question}" readonly>
        </div>
        <div class="mb-2">
          <label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
          <select class="form-select question-type" disabled>
            <option value="${q.type}" selected>${q.type === 'tracnghiem' ? 'Tr·∫Øc nghi·ªám' : q.type === 'truefalse' ? 'ƒê√∫ng / Sai' : 'Tr·∫£ l·ªùi ng·∫Øn'}</option>
          </select>
        </div>
        <div id="${qId}-options" class="mb-2">
          <label class="form-label">${q.type === 'shortanswer' ? 'ƒê√°p √°n ƒë√∫ng' : 'C√°c l·ª±a ch·ªçn:'}</label>
          <div class="row g-2">${optionsHtml}</div>
          ${q.type === 'tracnghiem' ? `
            <select class="form-select correct-answer mt-2" required>
              <option value="" disabled selected>Ch·ªçn ƒë√°p √°n ƒë√∫ng (A, B, C, D)</option>
              ${q.options.map((_, index) => `<option value="${index}">${String.fromCharCode(65 + index)}</option>`).join('')}
            </select>
            <div class="form-text text-danger">B·∫Øt bu·ªôc ch·ªçn ƒë√°p √°n ƒë√∫ng!</div>
          ` : q.type === 'truefalse' ? `
            <div class="form-text text-danger">Ch·ªçn ƒë√°p √°n ƒë√∫ng (A=ƒê√∫ng, B=Sai).</div>
          ` : ''}
        </div>
      `;
      document.getElementById("questionsContainer").appendChild(container);
    }

    loadTeacherClassrooms();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>