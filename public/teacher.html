<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω ƒë·ªÅ thi Pro - Exam Video</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --primary-color: #6f42c1;
    --primary-hover: #59359a;
    --card-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    --card-radius: 0.75rem;
    --transition-ease: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  body {
    font-family: 'Poppins', sans-serif;
    background-color: #f8f9fa;
    color: #333;
    overflow-x: hidden;
  }
  .navbar {
    background: linear-gradient(90deg, var(--primary-color), #a98eda);
    transition: var(--transition-ease);
  }
  .navbar:hover { box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
  .nav-tabs .nav-link { font-weight: 500; padding: 0.75rem 1.5rem; transition: var(--transition-ease); position: relative; }
  .nav-tabs .nav-link.active { color: var(--primary-color); border-color: var(--primary-color) var(--primary-color) #fff; position: relative; }
  .nav-tabs .nav-link.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--primary-color); animation: slideIn 0.3s ease-in-out; }
  @keyframes slideIn { from {width:0;} to {width:100%;} }
  .container { max-width: 1200px; }
  .card { border: none; border-radius: var(--card-radius); box-shadow: var(--card-shadow); transition: var(--transition-ease); margin-bottom: 1.5rem; }
  .card-body { padding: 2rem; }
  .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
  .btn-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
  .table { margin-top: 1rem; border-collapse: separate; border-spacing: 0 0.75rem; background-color: #fff; border-radius: var(--card-radius); overflow: hidden; }

  /* Giao di·ªán xem k·∫øt qu·∫£ m·ªõi */
  .result-table {
      border: 1px solid #dee2e6;
      border-radius: var(--card-radius);
      overflow: hidden;
  }
  .result-table th, .result-table td {
      padding: 1rem 1rem;
      border-color: #e9ecef !important;
  }
  .result-table thead th {
      background-color: var(--primary-color);
      color: white;
      font-weight: 600;
      border: none; /* X√≥a border gi·ªØa header */
  }
  .result-table tbody tr:hover {
      background-color: #f3f0ff;
  }
  .score-badge {
      min-width: 60px;
      font-size: 1.1rem;
      padding: 0.5em 1em;
      border-radius: 0.5rem;
      font-weight: 600;
  }
  .detail-table thead th {
      background-color: #e9ecef;
      color: #333;
      font-weight: 500;
  }
  .detail-table td {
      vertical-align: top;
  }
</style>
</head>
<body>
<nav class="navbar navbar-dark shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand" href="#"><i class="bi bi-journal-bookmark-fill"></i> <strong>ExamPro</strong> | Qu·∫£n l√Ω ƒë·ªÅ thi</a>
    <div id="userInfo" class="text-white"></div>
  </div>
</nav>
<main class="container py-5">
  <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="create-tab" data-bs-toggle="tab" data-bs-target="#create-pane" type="button" role="tab"><i class="bi bi-pencil-square"></i> T·∫°o ƒë·ªÅ thi</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-pane" type="button" role="tab"><i class="bi bi-bar-chart-line-fill"></i> Xem k·∫øt qu·∫£</button>
    </li>
  </ul>
  <div class="tab-content" id="myTabContent">
    <div class="tab-pane fade show active" id="create-pane" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <h3 class="card-title mb-4 border-bottom pb-2">Th√¥ng tin ƒë·ªÅ thi</h3>
          <form id="createExamForm">
            <div class="row g-3">
              <div class="col-md-6"><label class="form-label">T√™n ƒë·ªÅ thi</label><input type="text" id="title" class="form-control" placeholder="VD: ƒê·ªÅ thi cu·ªëi k·ª≥" required></div>
              <div class="col-md-3"><label class="form-label">M√¥n h·ªçc</label><input type="text" id="subject" class="form-control" placeholder="VD: To√°n" required></div>
              <div class="col-md-3"><label class="form-label">Th·ªùi gian (ph√∫t)</label><input type="number" id="duration" class="form-control" placeholder="VD: 60" required></div>
              <div class="col-12"><label class="form-label">ƒêo·∫°n vƒÉn ƒë·ªçc hi·ªÉu (n·∫øu c√≥)</label><textarea id="passage" class="form-control" rows="5" placeholder="Nh·∫≠p ƒëo·∫°n vƒÉn..."></textarea></div>
              <div class="col-12 mt-4">
                <label class="form-label fw-bold"><i class="bi bi-people-fill me-2"></i>Ph√¢n b·ªï l·ªõp h·ªçc</label>
                <div id="classroomCheckboxes" class="border p-3 rounded bg-light text-dark">
                  <div class="text-center text-muted" id="classroomLoading">ƒêang t·∫£i danh s√°ch l·ªõp h·ªçc...</div>
                </div>
              </div>
              <div class="col-12 mt-3"><label class="form-label">Import c√¢u h·ªèi t·ª´ file Word (.docx)</label><input type="file" id="importFile" accept=".docx" class="form-control">
                <small class="form-text text-muted">H·ªó tr·ª£ ƒë·ªãnh d·∫°ng: **C√¢u 1:** N·ªôi dung. **A.** L·ª±a ch·ªçn 1. **ƒê√°p √°n:** X (n·∫øu c√≥).</small>
                <button type="button" class="btn btn-secondary mt-2" onclick="importQuestions()"><i class="bi bi-upload"></i> Import</button>
              </div>
            </div>
            <h4 class="mt-5 border-bottom pb-2 mb-4">Danh s√°ch c√¢u h·ªèi</h4>
            <div id="questionsContainer"></div>
            <button type="button" class="btn btn-outline-primary mb-4" onclick="addQuestion()"><i class="bi bi-plus-circle-dotted"></i> Th√™m c√¢u h·ªèi</button>
            <button type="submit" class="btn btn-primary btn-lg w-100 fw-bold"><i class="bi bi-check-circle-fill"></i> Ho√†n t·∫•t & T·∫°o ƒë·ªÅ thi</button>
          </form>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="results-pane" role="tabpanel">
      <div class="card">
        <div class="card-body">
          <h3 class="card-title mb-4">Tra c·ª©u k·∫øt qu·∫£</h3>
          <div class="input-group mb-3">
            <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
            <input type="text" id="examId" class="form-control" placeholder="Nh·∫≠p Exam ID ƒë·ªÉ xem k·∫øt qu·∫£">
            <button class="btn btn-info text-white" onclick="loadResults()"><i class="bi bi-search"></i> Xem ƒëi·ªÉm</button>
            <button class="btn btn-warning text-dark" onclick="loadExitLogs()"><i class="bi bi-shield-exclamation"></i> L·ªãch s·ª≠ tho√°t</button>
          </div>
          <button class="btn btn-success mb-3" onclick="loadAllResults()"><i class="bi bi-collection"></i> Xem t·∫•t c·∫£ k·∫øt qu·∫£</button>
          <div id="loadingSpinner" class="text-center my-4 d-none">
            <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
            <p class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu...</p>
          </div>
          <div id="exitLogs"></div>
          <div id="results"></div>
        </div>
      </div>
    </div>
  </div>
</main>
<div class="modal fade" id="videoModal" tabindex="-1" aria-labelledby="videoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="videoModalLabel"><i class="bi bi-camera-video"></i> Video Gi√°m S√°t B√†i Thi</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <video id="examVideoPlayer" controls class="w-100" style="max-height:80vh;background:#000;">
          Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ video.
        </video>
      </div>
      <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button></div>
    </div>
  </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header" style="background-color: var(--primary-color); color: white;">
        <h5 class="modal-title" id="detailModalLabel"><i class="bi bi-person-lines-fill"></i> Chi ti·∫øt b√†i l√†m</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="detailModalBody">
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script>
let questionIndex=0;
let teacherClassrooms=[];
let examVideosMap={}; // Bi·∫øn global ƒë·ªÉ l∆∞u tr·ªØ map video

// H√†m t·∫£i danh s√°ch l·ªõp h·ªçc
async function loadTeacherClassrooms(){
  try{
    const res=await fetch("/api/classrooms/my");
    if(!res.ok)throw new Error("L·ªói t·∫£i l·ªõp");
    const data=await res.json();
    const box=document.getElementById("classroomCheckboxes");
    box.innerHTML="";
    if(!data.length){box.innerHTML="<div class='alert alert-warning'>Ch∆∞a c√≥ l·ªõp.</div>";return;}
    data.forEach(cls=>{
      box.innerHTML+=`<div class="form-check form-check-inline"><input class="form-check-input classroom-checkbox" type="checkbox" id="class-${cls._id}" value="${cls._id}">
      <label class="form-check-label" for="class-${cls._id}">${cls.name} <span class="text-muted">(${cls.students ? cls.students.length : 0} HS)</span></label></div>`;
    });
  }catch(e){
    console.error(e);
    document.getElementById("classroomCheckboxes").innerHTML="<div class='alert alert-danger'>L·ªói t·∫£i l·ªõp h·ªçc.</div>";
  }
}

// Th√™m c√¢u h·ªèi th·ªß c√¥ng
function addQuestion(){
  const qId="q"+Date.now();
  const div=document.createElement("div");
  div.classList.add("card","p-3","mb-3","question-card-new");
  questionIndex++;
  
  let optionsHtml = '';
  // T·ª± ƒë·ªông render 4 option m·∫∑c ƒë·ªãnh cho tr·∫Øc nghi·ªám
  for(let i=0; i<4; i++) {
      optionsHtml += `<div class="col-md-6"><span class="fw-bold me-2">${String.fromCharCode(65 + i)}.</span><input type="text" class="form-control option-input"></div>`;
  }
  
  div.innerHTML=`
<div class="d-flex justify-content-between align-items-center mb-2">
<h6 class="mb-0 text-primary">C√¢u h·ªèi ${questionIndex}</h6>
<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)"><i class="bi bi-trash3"></i> X√≥a</button>
</div>
<div class="mb-2"><label class="form-label">N·ªôi dung</label><input type="text" class="form-control question-text"></div>
<div class="mb-2"><label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
<select class="form-select question-type" onchange="renderOptions('${qId}',this.value)">
<option value="tracnghiem">Tr·∫Øc nghi·ªám</option>
<option value="truefalse">ƒê√∫ng / Sai</option>
<option value="shortanswer">T·ª± lu·∫≠n</option></select></div>
<div id="${qId}-options" class="mb-2">
    <label class="form-label">C√°c l·ª±a ch·ªçn:</label>
    <div class="row g-2">${optionsHtml}</div>
    <select class="form-select correct-answer mt-2">
        <option value="" disabled selected>ƒê√°p √°n ƒë√∫ng</option>
        <option value="0">A</option><option value="1">B</option><option value="2">C</option><option value="3">D</option>
    </select>
</div>`;

document.getElementById("questionsContainer").appendChild(div);
}
function removeQuestion(btn){const c=btn.closest('.card');c.classList.add('question-card-removing');c.addEventListener('animationend',()=>c.remove());}
// ‚úÖ S·ª¨A L·ªñI: C·∫≠p nh·∫≠t h√†m renderOptions ƒë·ªÉ ch·ªçn ƒë√°p √°n ƒë√∫ng
function renderOptions(qId,type, importedOptions=null, importedAnswer=null){
  const o=document.getElementById(`${qId}-options`);
  o.innerHTML="";
  if(type==="tracnghiem"){
    let optionsHtml = '';
    // ƒê·∫£m b·∫£o c√≥ √≠t nh·∫•t 4 √¥ input ƒë·ªÉ ch·ªçn ƒë√°p √°n A, B, C, D
    const optionsToRender = importedOptions && importedOptions.length > 0 ? importedOptions : ["", "", "", ""]; 
    const letters = ['A', 'B', 'C', 'D'];
    
    optionsToRender.slice(0, 4).forEach((opt, i) => {
        optionsHtml += `<div class="col-md-6"><span class="fw-bold me-2">${letters[i]}.</span><input type="text" class="form-control option-input" value="${opt}"></div>`;
    });

    // ‚úÖ S·ª¨A L·ªñI: D√πng importedAnswer ƒë·ªÉ ch·ªçn ƒë√°p √°n
    let selectOptions = letters.map((l, i) => `<option value="${i}" ${importedAnswer === i ? 'selected' : ''}>${l}</option>`).join("");
    
    o.innerHTML=`
<label class="form-label">C√°c l·ª±a ch·ªçn:</label>
<div class="row g-2">${optionsHtml}</div>
<select class="form-select correct-answer mt-2"><option value="" disabled ${importedAnswer == null ? 'selected' : ''}>ƒê√°p √°n ƒë√∫ng</option>${selectOptions}</select>`;
  }
else if(type==="truefalse"){
    const checkedDung = importedAnswer === 0 ? 'checked' : '';
    const checkedSai = importedAnswer === 1 ? 'checked' : '';
    // ‚úÖ S·ª¨A L·ªñI: ƒê·∫∑t name ri√™ng bi·ªát cho m·ªói c√¢u h·ªèi (qId-ans)
    o.innerHTML=`
<label class="form-label">ƒê√°p √°n ƒë√∫ng:</label>
<div class="row g-2">
<div class="col-md-6"><input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="0" ${checkedDung || (!checkedSai && !checkedDung ? 'checked' : '')}> ƒê√∫ng</div>
<div class="col-md-6"><input class="form-check-input correct-answer" type="radio" name="${qId}-ans" value="1" ${checkedSai}> Sai</div>
</div>`;
  }
else{o.innerHTML=`<label class="form-label">ƒê√°p √°n ƒë√∫ng (T·ª± lu·∫≠n)</label><input type="text" class="form-control correct-answer" value="${importedAnswer||""}">`;}
}

// X·ª≠ l√Ω t·∫°o ƒë·ªÅ thi (gi·ªØ nguy√™n)
document.getElementById("createExamForm").addEventListener("submit",async e=>{
  e.preventDefault();
  const title=document.getElementById("title").value.trim();
  const subject=document.getElementById("subject").value.trim();
  const duration=parseInt(document.getElementById("duration").value);
  const passage=document.getElementById("passage").value.trim();
  const classrooms=Array.from(document.querySelectorAll(".classroom-checkbox:checked")).map(c=>c.value);
  if(!classrooms.length){alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 l·ªõp h·ªçc.");return;}
  const questions=[];
  document.querySelectorAll("#questionsContainer .card").forEach(c=>{
    const question=c.querySelector(".question-text").value.trim();
    const type=c.querySelector(".question-type").value;
    let options=[],correctAnswer=null;
    
    if(type==="tracnghiem"){
      options=Array.from(c.querySelectorAll(".option-input")).map(i=>i.value).filter(v=>v.trim());
      const selectedIndex = c.querySelector(".correct-answer").value;
      correctAnswer = selectedIndex ? parseInt(selectedIndex) : null;
    }else if(type==="truefalse"){
      options=["ƒê√∫ng","Sai"];
      // S·ª¨A L·ªñI: ƒê·∫£m b·∫£o l·∫•y ƒë√∫ng radio button ƒë∆∞·ª£c ch·ªçn
      const qId = c.id; // L·∫•y ID c·ªßa card
      correctAnswer=parseInt(c.querySelector(`input[name="${qId}-ans"]:checked`)?.value);
    }else{
      correctAnswer=c.querySelector(".correct-answer")?.value||null;
    }
    
    questions.push({question,type,options,correctAnswer});
  });
  
  if(questions.length === 0) {
      alert("Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt c√¢u h·ªèi.");
      return;
  }
  
  try{
    const res=await fetch("/api/exams",{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({title,subject,duration,passage,questions,classrooms})});
    const data=await res.json();
    
    if(res.ok&&data.exam){alert(`‚úÖ T·∫°o ƒë·ªÅ th√†nh c√¥ng!\nExam ID: ${data.exam._id}`);}
    else alert("‚ùå L·ªói t·∫°o ƒë·ªÅ: "+(data.message||"Kh√¥ng r√µ"));
  }catch(err){alert("‚ùå L·ªói k·∫øt n·ªëi server.");}
});

// Load k·∫øt qu·∫£ (gi·ªØ nguy√™n)
async function loadExamVideos(examId){
  if(!examId)return;
  try{
    const res=await fetch(`/api/exam-videos?examId=${examId}`);
    if(!res.ok)throw new Error("Kh√¥ng th·ªÉ t·∫£i video");
    const vids=await res.json();
    examVideosMap=vids.reduce((map,v)=>{
      const key=`${v.examId._id||v.examId}_${v.userId}`;map[key]=v;return map;
    },{});
  }catch(e){console.error("‚ùå L·ªói t·∫£i video:",e);}
}
async function loadResults(){
  const examId=document.getElementById("examId").value.trim();
  if(!examId){alert("Nh·∫≠p Exam ID!");return;}
  const spinner=document.getElementById("loadingSpinner");
  const resultsDiv=document.getElementById("results");
  const exitLogs=document.getElementById("exitLogs");
  spinner.classList.remove("d-none");
  resultsDiv.innerHTML="";exitLogs.innerHTML="";
  try{
    const res=await fetch(`/api/exams/${examId}/results`);
    const data=await res.json();
    if(!res.ok){throw new Error("L·ªói t·∫£i k·∫øt qu·∫£");}
    const videoRes = await fetch(`/api/exam-videos?examId=${examId}`);
    const videos = await videoRes.json();
    const videoMap = {};
    videos.forEach(v => videoMap[v.userId] = v.videoUrl);
    data.forEach(r => {
      if (videoMap[r.userId]) r.videoUrl = videoMap[r.userId];
      if (!r.examId) r.examId = examId;
    });
    await loadExamVideos(examId);
    if(!data.length){resultsDiv.innerHTML="<div class='alert alert-info'>Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o.</div>";return;}
    
    let html=`<div class="table-responsive"><table class="table result-table table-hover align-middle"><thead><tr>
      <th>H·ªçc sinh</th><th>ƒêi·ªÉm hi·ªán t·∫°i</th><th>Chi ti·∫øt</th><th>Ch·∫•m ƒëi·ªÉm</th><th>Video</th></tr></thead><tbody>`;
    data.forEach(r=>{
      const scoreValue = r.score != null ? r.score : (r.autoScore != null ? r.autoScore : null);
      const scoreBadge = scoreValue != null 
          ? `<span class="badge ${scoreValue > 5 ? 'bg-success' : 'bg-danger'} score-badge">${scoreValue.toFixed(1)}/10</span>`
          : `<span class="badge bg-warning text-dark score-badge">---</span>`;
          
      html+=`<tr>
        <td class="fw-bold">${r.userId}</td>
        <td>${scoreBadge}</td>
        <td><button class="btn btn-sm btn-outline-primary" onclick='viewDetail(${JSON.stringify(r)})'><i class="bi bi-eye"></i> Xem</button></td>
        <td><button class="btn btn-sm btn-primary" onclick="gradeResult('${r._id}')"><i class="bi bi-check2-circle"></i> Ch·∫•m</button></td>
        <td>${r.videoUrl?
          `<button class="btn btn-sm btn-info text-white" onclick="showExamVideo('${r.examId}','${r.userId}')"><i class='bi bi-play-circle'></i></button>`:
          "<span class='text-muted'>Kh√¥ng c√≥</span>"}</td></tr>`;
    });
    html+="</tbody></table></div>";
    resultsDiv.innerHTML=html;
  }catch(e){
    console.error(e);
    resultsDiv.innerHTML="<div class='alert alert-danger'>Kh√¥ng th·ªÉ t·∫£i k·∫øt qu·∫£.</div>";
  }finally{spinner.classList.add("d-none");}
}
async function loadAllResults(){
  const resultsDiv=document.getElementById("results");
  const spinner=document.getElementById("loadingSpinner");
  spinner.classList.remove("d-none");resultsDiv.innerHTML="";
  try{
    const res=await fetch("/api/results");
    const data=await res.json();
    if(!data.length){resultsDiv.innerHTML="<div class='alert alert-info'>Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o.</div>";return;}
    await loadExamVideos(); 
    let html=`<div class="table-responsive"><table class="table result-table table-hover align-middle"><thead><tr>
    <th>H·ªçc sinh</th><th>ƒêi·ªÉm hi·ªán t·∫°i</th><th>Chi ti·∫øt</th><th>Ch·∫•m ƒëi·ªÉm</th><th>Video</th></tr></thead><tbody>`;
    data.forEach(r=>{
      const videoEntry = examVideosMap[`${r.examId}_${r.userId}`];
      r.videoUrl = videoEntry ? videoEntry.videoUrl : null;
      
      const scoreValue = r.score != null ? r.score : (r.autoScore != null ? r.autoScore : null);
      const scoreBadge = scoreValue != null 
          ? `<span class="badge ${scoreValue > 5 ? 'bg-success' : 'bg-danger'} score-badge">${scoreValue.toFixed(1)}/10</span>`
          : `<span class="badge bg-secondary score-badge">---</span>`;

      html+=`<tr><td class="fw-bold">${r.userId}</td><td>${scoreBadge}</td>
      <td><button class="btn btn-sm btn-outline-primary" onclick='viewDetail(${JSON.stringify(r)})'><i class="bi bi-eye"></i> Xem</button></td>
      <td><button class="btn btn-sm btn-primary" onclick="gradeResult('${r._id}')"><i class="bi bi-check2-circle"></i> Ch·∫•m</button></td>
      <td>${r.videoUrl?
        `<button class="btn btn-sm btn-info text-white" onclick="showExamVideo('${r.examId}','${r.userId}')"><i class='bi bi-play-circle'></i></button>`:
        "<span class='text-muted'>Kh√¥ng c√≥</span>"}</td></tr>`;
    });
    html+="</tbody></table></div>";
    resultsDiv.innerHTML=html;
  }catch(err){
    resultsDiv.innerHTML="<div class='alert alert-danger'>Kh√¥ng th·ªÉ t·∫£i t·∫•t c·∫£ k·∫øt qu·∫£.</div>";
  }finally{spinner.classList.add("d-none");}
}
async function loadExitLogs(){
  const examId=document.getElementById("examId").value.trim();
  if(!examId){alert("Nh·∫≠p Exam ID!");return;}
  const spinner=document.getElementById("loadingSpinner");
  const exitLogs=document.getElementById("exitLogs");
  const results=document.getElementById("results");
  spinner.classList.remove("d-none");exitLogs.innerHTML="";results.innerHTML="";
  try{
    const res=await fetch(`/api/exams/${examId}/exit-log`);
    const logs=await res.json();
    if(!logs.length){exitLogs.innerHTML="<div class='alert alert-success'>Kh√¥ng c√≥ h·ªçc sinh tho√°t gi·ªØa ch·ª´ng.</div>";return;}
    let html=`<h5><i class="bi bi-clock-history"></i> L·ªãch s·ª≠ tho√°t</h5><table class="table table-bordered"><thead class="table-light"><tr>
      <th>H·ªçc sinh</th><th>L√Ω do</th><th>Th·ªùi gian</th></tr></thead><tbody>`;
    logs.forEach(l=>{
      const time=new Date(l.timestamp).toLocaleString("vi-VN");
      html+=`<tr><td>${l.userId}</td><td><span class='badge bg-danger'>${l.reason}</span></td><td>${time}</td></tr>`;
    });
    html+="</tbody></table>";
    exitLogs.innerHTML=html;
  }catch(err){
    exitLogs.innerHTML="<div class='alert alert-danger'>L·ªói t·∫£i l·ªãch s·ª≠ tho√°t.</div>";
  }finally{spinner.classList.add("d-none");}
}
function getStatusBadge(stuAns,correct,type,opts){
  if(type==='shortanswer')return"<span class='badge bg-warning text-dark'>üìù GV Ch·∫•m</span>";
  if(stuAns==null)return"<span class='badge bg-secondary'>Ch∆∞a tr·∫£ l·ªùi</span>";
  if(parseInt(stuAns)===parseInt(correct))return"<span class='badge bg-success'>‚úÖ ƒê√∫ng</span>";
  return"<span class='badge bg-danger'>‚ùå Sai</span>";
}
function viewDetail(result){
  const modalBody = document.getElementById("detailModalBody");
  const scoreValue = result.score != null ? result.score : (result.autoScore != null ? result.autoScore : null);
  let scoreBadge = scoreValue != null 
      ? `<span class="badge ${scoreValue > 5 ? 'bg-success' : 'bg-danger'} fs-5 score-badge">${scoreValue.toFixed(1)}/10</span>`
      : `<span class="badge bg-secondary text-dark fs-5 score-badge">---</span>`;

  let html=`
    <div class="row mb-4 align-items-center p-3 border rounded shadow-sm">
      <div class="col-md-7">
        <p class="mb-1"><strong class="text-primary"><i class="bi bi-person-circle"></i> H·ªçc sinh:</strong> ${result.userId}</p>
        <p class="mb-1"><strong class="text-primary"><i class="bi bi-calendar-check"></i> N·ªôp b√†i:</strong> ${new Date(result.createdAt).toLocaleString('vi-VN')}</p>
        <p class="mb-0"><strong class="text-primary"><i class="bi bi-patch-check"></i> ƒêi·ªÉm hi·ªán t·∫°i:</strong> ${scoreBadge}</p>
      </div>
      <div class="col-md-5 text-md-end mt-3 mt-md-0">
          ${result.videoUrl ? 
            `<button class="btn btn-info text-white fw-bold" onclick="showExamVideo('${result.examId}', '${result.userId}')"><i class='bi bi-play-circle me-2'></i> Xem Video Gi√°m S√°t</button>` : 
            `<p class="text-muted"><i class="bi bi-camera-off"></i> Kh√¥ng c√≥ video gi√°m s√°t</p>`}
      </div>
    </div>
  `;

  html+=`<h6 class="mt-4 mb-3 text-muted border-bottom pb-2">Chi ti·∫øt t·ª´ng c√¢u h·ªèi</h6>
  <div class="table-responsive"><table class="table table-striped table-bordered detail-table align-middle">
  <thead><tr>
  <th style="width: 50px;">#</th><th>N·ªôi dung c√¢u h·ªèi</th><th style="width: 20%;">Tr·∫£ l·ªùi HS</th><th style="width: 20%;">ƒê√°p √°n ƒë√∫ng</th><th style="width: 100px;">Tr·∫°ng th√°i</th></tr></thead><tbody>`;
  
  result.answers.forEach((a,i)=>{
    let stuAns,correct;
    if(a.type==="tracnghiem"||a.type==="truefalse"){
      const s=(a.answer!=null)?parseInt(a.answer):null,c=(a.correctAnswer!=null)?parseInt(a.correctAnswer):null;
      stuAns=a.options?.[s]??"<i class='text-muted'>(Ch∆∞a tr·∫£ l·ªùi)</i>";
      correct=a.options?.[c]??"-";
    }else{
      stuAns=`<div class="text-break">${a.answer||"<i class='text-muted'>(ch∆∞a)</i>"}</div>`;
      correct=`<div class="text-break">${a.correctAnswer||"<i class='text-muted'>(GV ch·∫•m)</i>"}</div>`;
    }
    const status=getStatusBadge(a.answer,a.correctAnswer,a.type,a.options);
    html+=`<tr><td>${i+1}</td><td>${a.question}</td><td>${stuAns}</td><td>${correct}</td><td>${status}</td></tr>`;
  });
  html+="</tbody></table></div>";
  
  modalBody.innerHTML=html;
  const detailModal = new bootstrap.Modal(document.getElementById("detailModal"));
  detailModal.show();
}
async function gradeResult(id){
  const score=prompt("Nh·∫≠p ƒëi·ªÉm (0-10):");if(!score)return;
  const val=parseFloat(score);if(isNaN(val)||val<0||val>10){alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá.");return;}
  try{
    const res=await fetch(`/api/results/${id}/grade`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({score:val})});
    const data=await res.json();
    if(res.ok){alert("‚úÖ Ch·∫•m th√†nh c√¥ng!");loadResults();}
    else alert("‚ùå L·ªói: "+(data.message||"Kh√¥ng r√µ"));
  }catch(e){alert("‚ùå L·ªói k·∫øt n·ªëi.");}
}
function showExamVideo(examId,userId){
  const key=`${examId}_${userId}`,v=examVideosMap[key];
  if(v&&v.videoUrl){
    const player=document.getElementById("examVideoPlayer");
    player.src=v.videoUrl;
    const modal=new bootstrap.Modal(document.getElementById("videoModal"));
    modal.show();
    try {
      player.play();
    } catch (e) {
      console.warn("Autoplay blocked. User intervention required.");
    }
    document.getElementById("videoModal").addEventListener("hidden.bs.modal",()=>{
      player.pause();player.currentTime=0;player.src="";
    },{once:true});
  }else alert("Kh√¥ng t√¨m th·∫•y video thi.");
}

// C·∫£i thi·ªán logic parse file Word
function importQuestions(){
  const file=document.getElementById("importFile").files[0];
  if(!file){alert("Ch·ªçn file .docx!");return;}
  const reader=new FileReader();
  reader.onload=function(e){
    mammoth.extractRawText({arrayBuffer:e.target.result})
    .then(r=>parseAndAddQuestions(r.value))
    .catch(err=>{console.error("L·ªói ƒë·ªçc file:", err);alert("L·ªói ƒë·ªçc file. ƒê·∫£m b·∫£o file Word kh√¥ng ch·ª©a h√¨nh ·∫£nh ph·ª©c t·∫°p.");});
  };
  reader.readAsArrayBuffer(file);
}

function parseAndAddQuestions(text){
  const lines=text.split("\n").filter(l=>l.trim());
  let current=null;
  const questionsToImport = [];

  lines.forEach(line=>{
    const t=line.trim();
    
    // 1. Nh·∫≠n di·ªán b·∫Øt ƒë·∫ßu c√¢u h·ªèi m·ªõi (D·∫°ng: C√¢u 1: N·ªôi dung)
    if(/^C√¢u \d+[:.]/i.test(t) || /^\d+\./i.test(t)){
      if(current) questionsToImport.push(current);
      
      const questionText = t.replace(/^C√¢u \d+[:.]/i,"").replace(/^\d+\./i,"").trim();
      
      let type = "tracnghiem"; 
      
      if(/(ƒê√∫ng|Sai|True|False)\s*$/i.test(questionText)) {
          type = "truefalse";
      } 
      else if (/\(T·ª± lu·∫≠n\)|\[T·ª± lu·∫≠n\]|\(Tr·∫£ l·ªùi ng·∫Øn\)/i.test(questionText)) {
          type = "shortanswer";
      }
      
      current={
          question: questionText.replace(/\(.*\)/, "").replace(/\[.*\]/, "").trim(),
          type: type,
          options: [],
          correctAnswer: null 
      };
    } 
    // 2. Nh·∫≠n di·ªán c√°c l·ª±a ch·ªçn (D·∫°ng: A. L·ª±a ch·ªçn)
    else if(current && current.type === "tracnghiem" && /^[A-D]\./i.test(t)){
      current.options.push(t.replace(/^[A-D]\./i,"").trim());
    } 
    // 3. Nh·∫≠n di·ªán ƒë√°p √°n ƒë√∫ng (D·∫°ng: ƒê√°p √°n: A ho·∫∑c ƒê√°p √°n: N·ªôi dung)
    else if(current && /^ƒê√°p √°n[:]/i.test(t)){
      const answer = t.replace(/^ƒê√°p √°n[:]/i,"").trim();
      
      if(current.type === "tracnghiem") {
          const letter = answer.toUpperCase().charAt(0);
          if (letter >= 'A' && letter <= 'D') {
              // Chuy·ªÉn A, B, C, D th√†nh ch·ªâ s·ªë 0, 1, 2, 3
              current.correctAnswer = letter.charCodeAt(0) - 'A'.charCodeAt(0); 
          }
      } else if (current.type === "truefalse") {
          if (/ƒê√∫ng|True/i.test(answer)) current.correctAnswer = 0; // 0 l√† ƒê√∫ng
          else if (/Sai|False/i.test(answer)) current.correctAnswer = 1; // 1 l√† Sai
      } else if (current.type === "shortanswer") {
          current.correctAnswer = answer;
      }
    }
  });

  if(current) questionsToImport.push(current);
  
  questionsToImport.forEach(q => addImportedQuestion(q));

  alert(`‚úÖ Import xong ${questionsToImport.length} c√¢u h·ªèi.`);
}

// T·∫°o c·∫•u tr√∫c HTML gi·ªëng nh∆∞ addQuestion()
function addImportedQuestion(q){
  const qId="q"+Date.now();
  const div=document.createElement("div");
  // ‚úÖ S·ª¨A L·ªñI: G√°n ID cho card ƒë·ªÉ h√†m renderOptions c√≥ th·ªÉ t√¨m th·∫•y
  div.id = qId; 
  div.classList.add("card","p-3","mb-3","question-card-new");
  questionIndex++; 

  div.innerHTML=`
<div class="d-flex justify-content-between align-items-center mb-2">
<h6 class="mb-0 text-primary">C√¢u h·ªèi ${questionIndex}</h6>
<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(this)"><i class="bi bi-trash3"></i> X√≥a</button>
</div>
<div class="mb-2"><label class="form-label">N·ªôi dung</label><input type="text" class="form-control question-text" value="${q.question}"></div>
<div class="mb-2"><label class="form-label">Lo·∫°i c√¢u h·ªèi</label>
<select class="form-select question-type" onchange="renderOptions('${qId}',this.value)">
  <option value="tracnghiem" ${q.type === 'tracnghiem' ? 'selected' : ''}>Tr·∫Øc nghi·ªám</option>
  <option value="truefalse" ${q.type === 'truefalse' ? 'selected' : ''}>ƒê√∫ng / Sai</option>
  <option value="shortanswer" ${q.type === 'shortanswer' ? 'selected' : ''}>T·ª± lu·∫≠n</option>
</select></div>
<div id="${qId}-options" class="mb-2"></div>`; 

  document.getElementById("questionsContainer").appendChild(div);
  
  // G·ªçi renderOptions ƒë·ªÉ ƒëi·ªÅn c√°c l·ª±a ch·ªçn v√† ƒë√°p √°n ƒë√£ import
  renderOptions(qId, q.type, q.options, q.correctAnswer);
}

// G·ªçi h√†m loadTeacherClassrooms khi t·∫£i trang
loadTeacherClassrooms();
</script>
</body>
</html>