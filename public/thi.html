<!DOCTYPE html>
  <html lang="vi">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√†m b√†i thi</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
      /* --- C√ÄI ƒê·∫∂T CHUNG & CHO DI ƒê·ªòNG (MOBILE-FIRST) --- */
      body {
        font-family: 'Poppins', sans-serif;
        background-color: #f0f2f5;
      }

      .exam-header {
        background-color: #fff;
        border-bottom: 1px solid #dee2e6;
        z-index: 1030;
        /* D√≠nh tr√™n c√πng m√†n h√¨nh khi cu·ªôn tr√™n di ƒë·ªông */
        position: sticky;
        top: 0;
      }

      .exam-title {
          font-size: 1.2rem;
          font-weight: 600;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }

      #timer {
        font-weight: 600;
        font-size: 1.1rem;
        transition: color 0.3s;
      }

      #timer.timer-warning {
        color: #dc3545; /* M√†u ƒë·ªè c·∫£nh b√°o */
      }
      
      .scrollable-pane {
          padding: 1.5rem;
      }
      
      #passage-content .highlight {
        background-color: #ffc;
        cursor: pointer;
      }

      .question-card {
        background-color: #fff;
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      }

      .question-card .card-header {
          font-weight: 600;
          background-color: #f8f9fa;
          border-bottom: 1px solid #dee2e6;
      }

      .option-label {
        display: block;
        padding: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .option-label:hover {
        background-color: #e9ecef;
        border-color: #0d6efd;
      }
      .form-check-input:checked + .option-label {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
        font-weight: 500;
      }
      .form-check-input {
          display: none;
      }
      
      /* C√ÄI ƒê·∫∂T M·ªöI CHO WEBCAM */
      #cameraContainer {
          position: fixed; /* C·ªë ƒë·ªãnh tr√™n m√†n h√¨nh */
          bottom: 10px; /* ·ªû g√≥c d∆∞·ªõi b√™n ph·∫£i tr√™n mobile */
          right: 10px;
          z-index: 1040; /* ƒê·∫£m b·∫£o n·∫±m tr√™n c√°c th√†nh ph·∫ßn kh√°c */
          padding: 8px; /* Kho·∫£ng ƒë·ªám quanh video */
          background-color: rgba(255, 255, 255, 0.85); /* N·ªÅn m·ªù */
          border-radius: 12px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          /* TH√äM T√çNH NƒÇNG DI CHUY·ªÇN */
          cursor: move; 
      }

      #examCamera {
          width: 120px !important; /* Gi·∫£m k√≠ch th∆∞·ªõc video tr√™n mobile */
          height: 90px !important;
          border-width: 1px !important;
      }

      #cameraContainer p {
          font-size: 0.7rem; /* Gi·∫£m c·ª° ch·ªØ th√¥ng b√°o */
          margin-top: 5px;
          margin-bottom: 0;
          white-space: nowrap;
      }
      
      /* --- CSS CHO M√ÄN H√åNH L·ªöN (>= 768px) --- */
      @media (min-width: 768px) {
    body {
      display: flex;
      flex-direction: column;
      height: 100vh; /* To√†n m√†n h√¨nh */
      overflow: hidden; /* NgƒÉn body cu·ªôn */
    }

    .exam-header {
      position: static;
      flex-shrink: 0;
    }

    .main-content {
      flex-grow: 1;
      display: flex;
      height: 100%; /* To√†n chi·ªÅu cao c√≤n l·∫°i */
    }

    /* m·ªói c·ªôt c√≥ scroll ri√™ng */
    #passageColumn, #questionColumn {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    #passageColumn .scrollable-pane,
    #questionColumn .scrollable-pane {
      flex-grow: 1;
      overflow-y: auto;
      padding-bottom: 2rem;
    }

    /* Tu·ª≥ ch·ªânh thanh cu·ªôn */
    .scrollable-pane::-webkit-scrollbar { width: 8px; }
    .scrollable-pane::-webkit-scrollbar-track { background: #f1f1f1; }
    .scrollable-pane::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
    .scrollable-pane::-webkit-scrollbar-thumb:hover { background: #555; }
    
    /* ƒê∆∞a webcam l√™n g√≥c tr√™n b√™n ph·∫£i tr√™n m√†n h√¨nh l·ªõn */
    #cameraContainer {
        top: 80px; /* ƒê·∫∑t d∆∞·ªõi header m·ªôt ch√∫t */
        bottom: auto;
        right: 15px;
        padding: 10px;
    }
    
    #examCamera {
        width: 180px !important; /* K√≠ch th∆∞·ªõc l·ªõn h∆°n m·ªôt ch√∫t cho m√†n h√¨nh desktop */
        height: 135px !important;
    }

    #cameraContainer p {
        font-size: 0.8rem;
    }
  }
    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
  </head>
  <body>

    <div id="cameraContainer" class="text-center">
        <video id="examCamera" autoplay playsinline
          style="border-radius: 10px; border: 2px solid #007bff;"></video>
        <p class="text-muted">üé• Camera ƒëang ghi h√¨nh qu√° tr√¨nh l√†m b√†i</p>
    </div>

    <header class="exam-header shadow-sm py-2 px-3">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="exam-title mb-0" id="examTitle">‚úèÔ∏è ƒêang t·∫£i b√†i thi...</h1>
        <div class="d-flex align-items-center">
          <div id="timer" class="alert alert-info py-2 px-3 mb-0 me-3">‚è≥ --:--</div>
          <button type="button" class="btn btn-success fw-bold" data-bs-toggle="modal" data-bs-target="#confirmSubmitModal">
            <i class="bi bi-check-circle-fill me-2"></i>N·ªôp b√†i
          </button>
        </div>
      </div>
    </header>

    <main class="main-content row g-0">
      <div id="passageColumn" class="col-md-5 bg-white border-end">
        <div class="scrollable-pane">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">üìú ƒêo·∫°n vƒÉn tham kh·∫£o</h5>
            <button class="btn btn-outline-primary btn-sm" onclick="highlightSelection()">
              <i class="bi bi-highlighter"></i> ƒê√°nh d·∫•u
            </button>
          </div>
          <div id="passage-content" class="text-secondary" onclick="removeHighlight(event)"></div>
        </div>
      </div>

      <div id="questionColumn" class="col-md-7">
        <div class="scrollable-pane">
          <form id="examForm"></form>
        </div>
      </div>
    </main>

    <div class="modal fade" id="confirmSubmitModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">X√°c nh·∫≠n n·ªôp b√†i</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i thi kh√¥ng? M·ªçi thay ƒë·ªïi sau khi n·ªôp s·∫Ω kh√¥ng ƒë∆∞·ª£c ghi nh·∫≠n.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
            <button type="button" class="btn btn-primary" onclick="submitExam()">ƒê·ªìng √Ω n·ªôp b√†i</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="modal fade" id="resultModal" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
              <div class="modal-body text-center p-4">
                  <h3 id="resultTitle"></h3>
                  <p id="resultText" class="lead"></p>
                  <button type="button" class="btn btn-primary mt-3" onclick="window.location.href = 'exams.html'">V·ªÅ trang ch·ªß</button>
              </div>
          </div>
      </div>
  </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const examId = urlParams.get("id");
      let examData = null;
      let timeLeft = 0;
      let timerInterval = null;
      let examSubmitted = false;
      const confirmModal = new bootstrap.Modal(document.getElementById('confirmSubmitModal'));
      const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));

      // ‚úÖ TH√äM: T√≠nh nƒÉng k√©o th·∫£ (Draggable) cho camera
      function dragElement(elmnt) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        
        // S·ª≠ d·ª•ng to√†n b·ªô element l√†m drag handle
        elmnt.onmousedown = dragMouseDown;

        function dragMouseDown(e) {
          e = e || window.event;
          // NgƒÉn ch·∫∑n h√†nh vi m·∫∑c ƒë·ªãnh (nh∆∞ ch·ªçn vƒÉn b·∫£n)
          e.preventDefault(); 
          // L·∫•y v·ªã tr√≠ chu·ªôt ban ƒë·∫ßu
          pos3 = e.clientX;
          pos4 = e.clientY;
          document.onmouseup = closeDragElement;
          // G·ªçi h√†m m·ªói khi chu·ªôt di chuy·ªÉn
          document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
          e = e || window.event;
          e.preventDefault();
          // T√≠nh to√°n v·ªã tr√≠ chu·ªôt m·ªõi
          pos1 = pos3 - e.clientX;
          pos2 = pos4 - e.clientY;
          pos3 = e.clientX;
          pos4 = e.clientY;
          // ƒê·∫∑t v·ªã tr√≠ m·ªõi cho element
          
          // ƒê·∫£m b·∫£o kh√¥ng s·ª≠ d·ª•ng bottom/right/left/top c√πng l√∫c
          elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
          elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";

          // X√≥a c√°c thu·ªôc t√≠nh CSS c≈© ƒë·ªÉ ch·ªâ d√πng top/left,
          // ƒë·∫£m b·∫£o ƒë·ªãnh v·ªã tuy·ªát ƒë·ªëi/c·ªë ƒë·ªãnh kh√¥ng b·ªã xung ƒë·ªôt
          elmnt.style.bottom = "auto";
          elmnt.style.right = "auto";
        }

        function closeDragElement() {
          // Ng·ª´ng k√©o khi th·∫£ n√∫t chu·ªôt
          document.onmouseup = null;
          document.onmousemove = null;
        }
      }

      // ‚úÖ TH√äM: Check examId ngay t·ª´ ƒë·∫ßu
      if (!examId) {
        document.body.innerHTML = `
          <div class="container mt-5 text-center">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
              <h4>Thi·∫øu ID b√†i thi!</h4>
              <p>Vui l√≤ng ch·ªçn b√†i thi t·ª´ <a href="exams.html">danh s√°ch ƒë·ªÅ thi</a>.</p>
            </div>
          </div>
        `;
        throw new Error("Thi·∫øu ID b√†i thi trong URL");
      }

      console.log("Loading exam with ID:", examId); ¬†// ‚úÖ Log cho debug

      async function loadExam() {
        try {
          // ‚úÖ TH√äM: credentials cho session
          let res = await fetch(`/api/exams/${examId}`, { credentials: 'include' });
          
          // ‚úÖ TH√äM: Log status cho debug
          console.log("Exam fetch status:", res.status, res.statusText);
          
          if (!res.ok) {
            let errorMsg = "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu b√†i thi.";
            if (res.status === 401) errorMsg = "B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p l·∫°i.";
            else if (res.status === 403) errorMsg = "B·∫°n kh√¥ng c√≥ quy·ªÅn l√†m b√†i thi n√†y (ki·ªÉm tra l·ªõp h·ªçc).";
            else if (res.status === 404) errorMsg = "B√†i thi kh√¥ng t·ªìn t·∫°i ho·∫∑c ƒë√£ b·ªã x√≥a.";
            else if (res.status === 400) errorMsg = "ID b√†i thi kh√¥ng h·ª£p l·ªá.";
            throw new Error(errorMsg);
          }
          
          examData = await res.json();
          console.log("Exam data loaded:", examData); ¬†// Log data cho debug
          
          document.getElementById('examTitle').textContent = `‚úèÔ∏è ${examData.title}`;
          timeLeft = examData.duration * 60;
          
          // Hi·ªÉn th·ªã ƒëo·∫°n vƒÉn
          if (examData.passage) {
            document.getElementById('passage-content').innerHTML = `<p>${examData.passage.replace(/\n/g, '<br>')}</p>`;
          } else {
            document.getElementById("passageColumn").style.display = "none";
            document.getElementById("questionColumn").classList.remove("col-md-7");
            document.getElementById("questionColumn").classList.add("col-12");
          }

          // Hi·ªÉn th·ªã c√¢u h·ªèi
          let html = "";
          examData.questions.forEach((q, i) => {
            html += `
              <div class="card question-card mb-4">
                <div class="card-header">C√¢u ${i+1}: ${q.question}</div>
                <div class="card-body">`;
            
            if (q.type === "tracnghiem") {
              q.options.forEach((opt, j) => {
                html += `
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="q${i}" id="q${i}o${j}" value="${j}">
                    <label class="form-check-label option-label" for="q${i}o${j}">${opt}</label>
                  </div>`;
              });
            } else if (q.type === "truefalse") {
              html += `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="q${i}" id="q${i}o0" value="0">
                    <label class="form-check-label option-label" for="q${i}o0">ƒê√∫ng</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="q${i}" id="q${i}o1" value="1">
                    <label class="form-check-label option-label" for="q${i}o1">Sai</label>
                </div>`;
            } else {
              html += `<textarea class="form-control" name="q${i}" rows="4" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n..."></textarea>`;
            }
            html += "</div></div>";
          });

          document.getElementById("examForm").innerHTML = html;

          // --- RENDER LaTeX ·ªü ƒë√¢y, sau khi n·ªôi dung ƒë√£ c√≥ trong DOM ---
          const renderOptions = {
            delimiters: [
              {left: "$$", right: "$$", display: true},
              {left: "\\[", right: "\\]", display: true},
              {left: "$", right: "$", display: false},
              {left: "\\(", right: "\\)", display: false}
            ],
            throwOnError: false
          };

          function tryRender() {
            if (window.renderMathInElement) {
              try {
                const passageEl = document.getElementById('passage-content');
                const formEl = document.getElementById('examForm');
                if (passageEl) renderMathInElement(passageEl, renderOptions);
                if (formEl) renderMathInElement(formEl, renderOptions);
              } catch (err) {
                console.error("L·ªói khi render LaTeX:", err);
              }
            } else {
              // n·∫øu auto-render ch∆∞a s·∫µn s√†ng th√¨ th·ª≠ l·∫°i sau 200ms (v√†i l·∫ßn)
              setTimeout(() => {
                if (window.renderMathInElement) {
                  tryRender();
                } else {
                  // m·ªôt l·∫ßn n·ªØa th·ª≠ sau 400ms
                  setTimeout(() => {
                    if (window.renderMathInElement) tryRender();
                    else console.warn("renderMathInElement kh√¥ng t√¨m th·∫•y ‚Äî KaTeX c√≥ th·ªÉ ch∆∞a load.");
                  }, 400);
                }
              }, 200);
            }
          }
          tryRender();

          // ‚úÖ TH√äM: G·ªçi startTimer ·ªü ƒë√¢y, sau khi load th√†nh c√¥ng
          startTimer();
        } catch (error) {
          console.error("Load exam error:", error); ¬†// ‚úÖ Log ƒë·∫ßy ƒë·ªß l·ªói
          document.body.innerHTML = `
            <div class="container mt-5 text-center">
              <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle fs-1 mb-3"></i>
                <h4>${error.message}</h4>
                <p>Vui l√≤ng quay l·∫°i <a href="exams.html">danh s√°ch ƒë·ªÅ thi</a> v√† th·ª≠ l·∫°i.</p>
              </div>
            </div>
          `;
        }
      }

      // ‚úÖ ƒê·ªäNH NGHƒ®A FUNCTION startTimer
      function startTimer() {
        const timerEl = document.getElementById("timer");
        timerInterval = setInterval(() => {
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            timerEl.textContent = "‚åõ H·∫øt gi·ªù!";
            submitExam(true); // T·ª± ƒë·ªông n·ªôp b√†i khi h·∫øt gi·ªù
            return;
          }

          timeLeft--;
          const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
          const seconds = String(timeLeft % 60).padStart(2, '0');
          timerEl.innerHTML = `‚è≥ ${minutes}:${seconds}`;

          if (timeLeft < 60) {
            timerEl.classList.add('timer-warning');
          }
        }, 1000);
      }

      async function submitExam(isAutoSubmit = false) {
    if (!isAutoSubmit) {
      confirmModal.hide();
    }
    clearInterval(timerInterval);
    examSubmitted = true; 
    console.log("‚èπ D·ª´ng ghi h√¨nh v√† l∆∞u video tr∆∞·ªõc khi n·ªôp b√†i...");

  try {
    const videoBlob = await stopRecording(); // D·ª´ng camera v√† l·∫•y video
    if (videoBlob) await uploadExamVideo(videoBlob); // Upload video n·∫øu c√≥
  } catch (err) {
    console.error("‚ö†Ô∏è Kh√¥ng th·ªÉ l∆∞u video:", err);
  }
    let answers = [];
    examData.questions.forEach((q, i) => {
      let val = null;
      if (q.type === "tracnghiem" || q.type === "truefalse") {
        const checked = document.querySelector(`input[name="q${i}"]:checked`);
        val = checked ? checked.value : null;
      } else { // 'shortanswer' or other types
        const textarea = document.querySelector(`textarea[name="q${i}"]`);
        val = textarea ? textarea.value.trim() : "";
      }
      answers.push(val);
    });

    try {
      const res = await fetch(`/api/exams/${examId}/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include", ¬†
        body: JSON.stringify({ answers })
      });
      const data = await res.json();
      
      // ----------------------------------------------------
      // ‚úÖ PH·∫¶N T√çNH V√Ä HI·ªÇN TH·ªä ƒêI·ªÇM V√Ä NG√ÄY GI·ªú N·ªòP B√ÄI
      // ----------------------------------------------------
      
      const autoGradedCount = examData.questions.filter(q => q.type !== 'shortanswer').length;
      // D√πng correctCount t·ª´ API ƒë√£ s·ª≠a trong server.js
      const rightAnswers = data.correctCount ?? 0; 
      const totalQuestions = examData.questions.length;
      const shortAnswerCount = totalQuestions - autoGradedCount;
      
      let outOf10 = '0.0';
      let resultText = "";
      let submittedTimeInfo = "";
      let gradingNote = ""; // Chu·∫©n b·ªã cho ghi ch√∫ t·ª± lu·∫≠n

      if (autoGradedCount > 0) {
        // T√≠nh ƒëi·ªÉm tr√™n thang 10 v√† l√†m tr√≤n 1 ch·ªØ s·ªë th·∫≠p ph√¢n
        outOf10 = ((rightAnswers / autoGradedCount) * 10).toFixed(1);
      }
      
      let finalScore = outOf10;

      // 1. T·∫°o chu·ªói k·∫øt qu·∫£ ƒëi·ªÉm
      if (autoGradedCount === 0) {
          finalScore = "---";
          resultText = `K·∫øt qu·∫£ c·ªßa b·∫°n: ${finalScore} (B√†i thi T·ª± lu·∫≠n).`;
      } else if (shortAnswerCount > 0) {
          // Hi·ªÉn th·ªã ƒëi·ªÉm tr·∫Øc nghi·ªám chi ti·∫øt
          resultText = `K·∫øt qu·∫£ c·ªßa b·∫°n: ${finalScore}/10 
(ƒê√∫ng ${rightAnswers}/${autoGradedCount} c√¢u tr·∫Øc nghi·ªám).`;
          gradingNote = "\nPh·∫ßn t·ª± lu·∫≠n s·∫Ω ƒë∆∞·ª£c gi√°o vi√™n ch·∫•m sau.";
      } else {
          // Ch·ªâ c√≥ tr·∫Øc nghi·ªám
          resultText = `K·∫øt qu·∫£ c·ªßa b·∫°n: ${finalScore}/10`;
      }

      // 2. X·ª≠ l√Ω v√† th√™m th√¥ng tin ng√†y gi·ªù n·ªôp b√†i
      if (data.submittedAt) {
          const submitted = new Date(data.submittedAt); 
          const dateStr = submitted.toLocaleDateString('vi-VN'); 
          const timeStr = submitted.toLocaleTimeString('vi-VN');
          submittedTimeInfo = `\nTh·ªùi gian n·ªôp b√†i: ${timeStr}, ng√†y ${dateStr}.`;
      }
      
      // K·∫øt h·ª£p t·∫•t c·∫£
      document.getElementById('resultTitle').innerHTML = isAutoSubmit ? 'üîî H·∫øt gi·ªù!' : '‚úÖ N·ªôp b√†i th√†nh c√¥ng!';
      // S·ª≠ d·ª•ng textContent ƒë·ªÉ gi·ªØ ƒë·ªãnh d·∫°ng xu·ªëng d√≤ng (\n)
      document.getElementById('resultText').textContent = resultText + submittedTimeInfo + gradingNote;
      resultModal.show();
      
    } catch (error) {
      document.getElementById('resultTitle').innerHTML = '‚ùå ƒê√£ x·∫£y ra l·ªói!';
      document.getElementById('resultText').textContent = 'Kh√¥ng th·ªÉ n·ªôp b√†i thi. Vui l√≤ng ki·ªÉm tra l·∫°i k·∫øt n·ªëi.';
      resultModal.show();
    }
}

      // --- Ch·ª©c nƒÉng ƒë√°nh d·∫•u ch·ªØ (ƒê√É ƒê∆ØA RA NGO√ÄI H√ÄM submitExam) ---
      function highlightSelection() {
        const selection = window.getSelection();
        if (!selection.rangeCount || selection.isCollapsed) return;
        
        const range = selection.getRangeAt(0);
        const span = document.createElement('span');
        span.className = 'highlight';
        
        try {
          range.surroundContents(span);
        } catch (e) {
          console.warn("Kh√¥ng th·ªÉ ƒë√°nh d·∫•u v√πng ch·ªçn n√†y.", e);
        }
        selection.removeAllRanges();
      }

      function removeHighlight(event) {
        const target = event.target;
        if (target.classList.contains('highlight')) {
          const parent = target.parentNode;
          while (target.firstChild) {
            parent.insertBefore(target.firstChild, target);
          }
          parent.removeChild(target);
          parent.normalize(); // G·ªôp c√°c text node l·∫°i
        }
      }

      async function reportExit(reason) {
        try {
          await fetch(`/api/exams/${examId}/exit-log`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include", ¬†// ‚úÖ Th√™m credentials
            body: JSON.stringify({ reason })
          });
        } catch (err) {
          console.error("Kh√¥ng ghi ƒë∆∞·ª£c log tho√°t:", err);
        }
      }

      // Khi ƒë√≥ng tab ho·∫∑c reload
      window.addEventListener("beforeunload", function (e) {
        reportExit("ƒê√≥ng tab ho·∫∑c t·∫£i l·∫°i");
        e.preventDefault();
        e.returnValue = "B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën tho√°t? L·ªãch s·ª≠ s·∫Ω b·ªã ghi l·∫°i.";
      });

      // Khi chuy·ªÉn tab ho·∫∑c ·∫©n c·ª≠a s·ªï
      document.addEventListener("visibilitychange", function () {
        if (document.hidden && !examSubmitted) {
          reportExit("Chuy·ªÉn tab ho·∫∑c ·∫©n c·ª≠a s·ªï");
        }
      });

      loadExam();
      let mediaRecorder;
let recordedChunks = [];

async function initCamera() {
  const video = document.getElementById("examCamera");
  const cameraContainer = document.getElementById("cameraContainer"); // L·∫•y container
  try {
    // üé• Y√™u c·∫ßu quy·ªÅn camera
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;

    // ‚úÖ B·∫Øt ƒë·∫ßu ghi h√¨nh
    startRecording(stream);
    
    // ‚úÖ K√çCH HO·∫†T K√âO TH·∫¢
    dragElement(cameraContainer);
    console.log("‚úÖ Camera ƒë√£ b·∫≠t v√† ƒëang ghi h√¨nh...");

  } catch (err) {
    console.error("‚ùå Kh√¥ng th·ªÉ b·∫≠t camera:", err);

    // üö´ Kh√¥ng cho thi n·∫øu kh√¥ng b·∫≠t camera
    document.body.innerHTML = `
      <div class="container mt-5 text-center">
        <div class="alert alert-danger p-4">
          <h3>üö´ B·∫°n c·∫ßn b·∫≠t camera ƒë·ªÉ l√†m b√†i thi.</h3>
          <p>Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p camera cho tr√¨nh duy·ªát, sau ƒë√≥ t·∫£i l·∫°i trang.</p>
        </div>
      </div>
    `;
    throw new Error("Camera kh√¥ng ƒë∆∞·ª£c b·∫≠t");
  }
}

function startRecording(stream) {
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

  mediaRecorder.ondataavailable = (event) => {
    if (event.data.size > 0) recordedChunks.push(event.data);
  };

  mediaRecorder.start();
  console.log("üé¨ ƒêang ghi h√¨nh...");
}

// G·ªçi h√†m khi trang v·ª´a load
initCamera();

function stopRecording() {
  return new Promise((resolve) => {
    if (!mediaRecorder || mediaRecorder.state === "inactive") return resolve(null);

    mediaRecorder.onstop = () => {
      const blob = new Blob(recordedChunks, { type: "video/webm" });
      resolve(blob);
    };
    mediaRecorder.stop();
  });
}

// G·ª≠i video l√™n server khi n·ªôp b√†i
async function uploadExamVideo(blob) {
  const userData = JSON.parse(localStorage.getItem("userData") || "{}");
  console.log("üì§ G·ª≠i video l√™n server‚Ä¶", { examId, userId: userData.username }); // ‚Üê th√™m

  const formData = new FormData();
  formData.append("video", blob, "exam_record.webm");
  formData.append("examId", examId);
  formData.append("classId", examData?.classroomId || "");
  formData.append("userId", userData.username || "unknown");

  const res = await fetch("/api/upload-exam-video", { method: "POST", body: formData });
  const data = await res.json();
  console.log("üì• Ph·∫£n h·ªìi server:", data); // ‚Üê th√™m
}



function stopCameraStream() {
  const video = document.getElementById("examCamera");
  const stream = video.srcObject;
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
    console.log("üì∑ Camera ƒë√£ t·∫Øt sau khi n·ªôp b√†i.");
  }
}
    </script>
  </body>
  </html>