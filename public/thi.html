<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Làm bài thi</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="text-center mb-4">✏️ Làm bài thi</h1>
    <div class="alert alert-info text-center" id="timer">⏳ Đang tải...</div>
    <form id="examForm" class="mb-3"></form>
    <button type="button" class="btn btn-success w-100" onclick="submitExam()">Nộp bài</button>
  </div>

  <script>
    const examId = new URLSearchParams(window.location.search).get("id");
    let examData = null;
    let timeLeft = 0;

    async function loadExam() {
      let res = await fetch(`/api/exams/${examId}`);
      examData = await res.json();
      timeLeft = examData.duration * 60;

      let html = "";
      examData.questions.forEach((q, i) => {
        html += `
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h5>Câu ${i+1}: ${q.question}</h5>`;
        if (q.type === "tracnghiem") {
  q.options.forEach((opt, j) => {
    html += `
      <div class="form-check">
        <input class="form-check-input" type="radio" name="q${i}" value="${j}">
        <label class="form-check-label">${opt}</label>
      </div>`;
  });
} else if (q.type === "truefalse") {
  html += `
    <div class="form-check">
      <input class="form-check-input" type="radio" name="q${i}" value="0">
      <label class="form-check-label">Đúng</label>
    </div>
    <div class="form-check">
      <input class="form-check-input" type="radio" name="q${i}" value="1">
      <label class="form-check-label">Sai</label>
    </div>`;
} else {
  html += `<textarea class="form-control" name="q${i}" rows="3"></textarea>`;
}

        html += "</div></div>";
      });

      document.getElementById("examForm").innerHTML = html;
      startTimer();
    }

    function startTimer() {
      let timerEl = document.getElementById("timer");
      let interval = setInterval(() => {
        let minutes = Math.floor(timeLeft / 60);
        let seconds = timeLeft % 60;
        timerEl.innerText = `⏳ Thời gian còn lại: ${minutes}:${seconds}`;
        timeLeft--;
        if (timeLeft < 0) {
          clearInterval(interval);
          submitExam();
        }
      }, 1000);
    }

    async function submitExam() {
      let answers = [];
      examData.questions.forEach((q, i) => {
  let val = null;
  if (q.type === "tracnghiem" || q.type === "truefalse") {
    const checked = document.querySelector(`input[name="q${i}"]:checked`);
    val = checked ? checked.value : null;
  } else if (q.type === "shortanswer") {
    const textarea = document.querySelector(`textarea[name="q${i}"]`);
    val = textarea ? textarea.value : "";
  }
  answers.push(val);
});

      let res = await fetch(`/api/exams/${examId}/submit`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers })
      });
      let data = await res.json();
      const autoGraded = examData.questions.filter(q => q.type === "tracnghiem" || q.type === "truefalse").length;
alert("✅ Đã nộp! Điểm: " + data.score + "/" + autoGraded);

      window.location.href = "exams.html";
    }

    loadExam();
  </script>
</body>
</html>
