<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Video Call</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; text-align: center; }
    .video-box { display: inline-block; margin: 10px; }
    video { width: 300px; height: 200px; border: 2px solid #444; border-radius: 10px; }
    .label { background: #222; color: #fff; padding: 2px 6px; border-radius: 5px; margin-top: 4px; display: inline-block; }
    button { margin: 5px; padding: 10px 20px; font-size: 14px; }
  </style>
</head>
<body>
  <h2>üìπ Video Call WebRTC</h2>
  <div id="username">ƒêang ƒëƒÉng nh·∫≠p: ...</div>
  <button id="startBtn">B·∫≠t Camera</button>
  <button id="callBtn">G·ªçi</button>
  <button id="endBtn">T·∫Øt G·ªçi</button>
  <div id="videos"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let localStream;
    let peers = {}; // ch·ª©a danh s√°ch peer connections
    const videosDiv = document.getElementById("videos");
    const usernameDiv = document.getElementById("username");
    let myUsername = "·∫®n danh";

    // üìå L·∫•y t√™n ƒëƒÉng nh·∫≠p
    fetch("/me").then(res => res.json()).then(data => {
      if (data.username) {
        myUsername = data.username;
        usernameDiv.textContent = "ƒêang ƒëƒÉng nh·∫≠p: " + myUsername;
        socket.emit("join-call", myUsername);
      }
    });

    // B·∫≠t camera
    document.getElementById("startBtn").onclick = async () => {
      localStream = await navigator.mediaDevices.getUserMedia({ video: { frameRate: 60 }, audio: true });
      addVideo(localStream, myUsername + " (B·∫°n)", "local");
    };

    // B·∫Øt ƒë·∫ßu g·ªçi
    document.getElementById("callBtn").onclick = async () => {
      startCall();
    };

    // T·∫Øt g·ªçi
    document.getElementById("endBtn").onclick = () => {
      Object.values(peers).forEach(peer => peer.close());
      peers = {};
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      document.getElementById("videos").innerHTML = "";
    };

    function addVideo(stream, label, id) {
      let box = document.createElement("div");
      box.className = "video-box";
      box.id = "box-" + id;
      let video = document.createElement("video");
      video.autoplay = true; video.playsinline = true;
      if (id === "local") video.muted = true;
      video.srcObject = stream;
      let span = document.createElement("div");
      span.className = "label";
      span.textContent = label;
      box.appendChild(video);
      box.appendChild(span);
      videosDiv.appendChild(box);
    }

    function startCall() {
      // t·∫°o peer m·ªõi
      const peer = new RTCPeerConnection();
      peers["host"] = peer;
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

      peer.onicecandidate = e => { if (e.candidate) socket.emit("ice-candidate", e.candidate); };
      peer.ontrack = e => addVideo(e.streams[0], "Ng∆∞·ªùi g·ªçi kh√°c", "remote");

      peer.createOffer().then(offer => {
        peer.setLocalDescription(offer);
        socket.emit("offer", offer);
      });
    }

    // Nh·∫≠n user m·ªõi
    socket.on("user-joined", data => {
      console.log("Ng∆∞·ªùi m·ªõi:", data.username);
    });

    // Signaling
    socket.on("offer", async data => {
      const peer = new RTCPeerConnection();
      peers[data.from] = peer;
      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

      peer.onicecandidate = e => { if (e.candidate) socket.emit("ice-candidate", { candidate: e.candidate, to: data.from }); };
      peer.ontrack = e => addVideo(e.streams[0], data.username || "Ng∆∞·ªùi kh√°c", data.from);

      await peer.setRemoteDescription(new RTCSessionDescription(data));
      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);
      socket.emit("answer", { answer, to: data.from });
    });

    socket.on("answer", data => {
      peers[data.from]?.setRemoteDescription(new RTCSessionDescription(data));
    });

    socket.on("ice-candidate", data => {
      if (data.from && peers[data.from]) {
        peers[data.from].addIceCandidate(new RTCIceCandidate(data));
      }
    });

    socket.on("user-left", data => {
      let box = document.getElementById("box-" + data.id);
      if (box) box.remove();
    });
  </script>
</body>
</html>
