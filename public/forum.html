<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üí¨ G√≥c h·ªèi ƒë√°p</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #3d36b6;
      --primary-color-light: #79b2ff;
      --secondary-color: #9c27b0;
      --background-start: #0f0c29;
      --background-mid: #302b63;
      --background-end: #24243e;
      --surface-color: rgba(30, 30, 50, 0.55);
      --surface-color-hover: rgba(40, 40, 60, 0.7);
      --glass-border-color: rgba(255, 255, 255, 0.15);
      --primary-text-color: #f0f0f5;
      --secondary-text-color: #a0a8c2;
      --danger-color: #ef5350;
      --warning-color: #ffa726;
      --success-color: #66bb6a;
      --border-radius: 16px;
      --box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --font-family: 'Poppins', sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--font-family);
      background: linear-gradient(-45deg, var(--background-start), var(--background-mid), var(--background-end));
      background-size: 400% 400%;
      animation: gradient 15s ease infinite;
      color: var(--primary-text-color);
      line-height: 1.7;
    }

    @keyframes gradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    main {
      padding: 40px 0;
    }

    .container {
      max-width: 800px;
      margin: auto;
      padding: 0 15px;
    }

    .page-title {
  text-align: center;
  font-size: 2.6rem;
  font-weight: 700;
  margin-bottom: 40px;
  margin-top: 30px;
  background: linear-gradient(90deg, var(--primary-color-light), var(--secondary-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-transform: uppercase;
  letter-spacing: 1px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

/* üåü Hi·ªáu ·ª©ng ph√°t s√°ng ch·ªØ khi hover */
.page-title:hover {
  text-shadow:
    0 0 5px rgba(121,178,255,0.8),
    0 0 10px rgba(121,178,255,0.6),
    0 0 15px rgba(121,178,255,0.5),
    0 0 25px rgba(121,178,255,0.4),
    0 0 40px rgba(121,178,255,0.3);
  transform: scale(1.03);
}

/* ‚ú® Hi·ªáu ·ª©ng ‚Äúnh·ªãp s√°ng‚Äù li√™n t·ª•c (t√πy ch·ªçn) */
.page-title {
  animation: subtleGlow 3s ease-in-out infinite alternate;
}

@keyframes subtleGlow {
  from {
    text-shadow:
      0 0 5px rgba(121,178,255,0.3),
      0 0 10px rgba(121,178,255,0.2);
  }
  to {
    text-shadow:
      0 0 8px rgba(121,178,255,0.6),
      0 0 15px rgba(121,178,255,0.4);
  }
}


    .card {
      background: var(--surface-color);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 25px;
      margin-bottom: 30px;
      border-radius: var(--border-radius);
      border: 1px solid var(--glass-border-color);
      box-shadow: var(--box-shadow);
      transition: 0.3s;
    }

    .card:hover {
      background: var(--surface-color-hover);
      transform: translateY(-5px);
    }

    /* --- Form ƒëƒÉng b√†i --- */
    #postForm textarea {
      width: 100%;
      background: rgba(0,0,0,0.25);
      color: var(--primary-text-color);
      border: 1px solid var(--glass-border-color);
      border-radius: 12px;
      padding: 15px;
      resize: vertical;
      min-height: 120px;
      outline: none;
      transition: 0.3s;
    }
    #postForm textarea:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(121,178,255,0.3);
    }

    .post-form-controls {
      display: flex;
      gap: 15px;
      justify-content: space-between;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      color: #fff;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: 0.3s;
    }

    label.btn {
      background: #444b66;
    }
    label.btn:hover {
      background: #2c334d;
    }

    .btn.btn-primary {
      background: linear-gradient(90deg, var(--primary-color), var(--primary-color-light));
    }
    .btn.btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(58, 141, 255, 0.4);
    }

    #imagePreview img {
      margin-top: 15px;
      width: 100%;
      max-height: 350px;
      object-fit: cover;
      border-radius: 10px;
    }

    /* --- B√†i ƒëƒÉng --- */
    .post-header {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid var(--glass-border-color);
      margin-bottom: 15px;
      padding-bottom: 10px;
    }

    .post-author { font-weight: 600; color: white; }
    .post-time { font-size: 0.85rem; color: var(--secondary-text-color); }

    .post-caption { margin: 10px 0 15px; white-space: pre-wrap; }

    .post-image img {
      max-height: 500px;
      width: 100%;
      object-fit: contain;
      border-radius: 10px;
    }

    .post-actions button {
      background: none;
      border: none;
      color: var(--secondary-text-color);
      cursor: pointer;
      font-size: 1.2rem;
      margin-left: 10px;
      transition: 0.3s;
    }
    .post-actions button:hover { color: white; }
    .btn-delete:hover { color: var(--danger-color) !important; }
    .btn-report:hover { color: var(--warning-color) !important; }

    /* --- B√¨nh lu·∫≠n --- */
    .comments-section {
      margin-top: 20px;
      border-top: 1px solid var(--glass-border-color);
      padding-top: 15px;
    }
    .comment {
      background: rgba(0,0,0,0.25);
      padding: 10px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .comment-author { font-weight: 600; color: white; }
    .comment-meta { font-size: 0.8rem; color: var(--secondary-text-color); }
    .comment-content img {
      max-width: 180px;
      margin-top: 6px;
      border-radius: 8px;
    }

    .comment-form {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }
    .comment-form input[type="text"] {
      flex: 1;
      padding: 10px 15px;
      border-radius: 25px;
      border: 1px solid var(--glass-border-color);
      background: rgba(0,0,0,0.25);
      color: var(--primary-text-color);
    }

    /* --- Toast notification --- */
    #notification-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
    }
    .toast {
      padding: 12px 18px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      animation: fadeOut 3s forwards;
    }
    .toast.success { background: var(--success-color); }
    .toast.error { background: var(--danger-color); }
    .toast.info { background: var(--primary-color); }
    @keyframes fadeOut {
      0%, 90% { opacity: 1; transform: translateX(0); }
      100% { opacity: 0; transform: translateX(50px); }
    }
    /* üå´Ô∏è Hi·ªáu ·ª©ng fade-in m∆∞·ª£t cho to√†n trang */
body {
  opacity: 0;
  animation: bodyFadeIn 0.8s ease-out forwards;
}

@keyframes bodyFadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ü™Ñ Fade-in cho t·ª´ng card b√†i ƒëƒÉng */
.card {
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInCard 0.6s ease-out forwards;
}
@keyframes fadeInCard {
  to { opacity: 1; transform: translateY(0); }
}

/* üí¨ Fade-in cho comment */
.comment {
  opacity: 0;
  transform: translateY(10px);
  animation: fadeInComment 0.4s ease-out forwards;
}
@keyframes fadeInComment {
  to { opacity: 1; transform: translateY(0); }
}
/* üåü Vi·ªÅn s√°ng m∆∞·ª£t cho khung ƒëƒÉng b√†i */
.card:first-of-type {
  position: relative;
  border: 1px solid var(--glass-border-color);
  transition: border-color 0.3s ease, box-shadow 0.4s ease;
}

/* Khi hover, ch·ªâ vi·ªÅn s√°ng nh·∫π quanh khung */
.card:first-of-type:hover {
  border-color: rgba(121,178,255,0.8);
  box-shadow:
    0 0 8px rgba(121,178,255,0.3),
    0 0 15px rgba(121,178,255,0.2),
    0 0 25px rgba(121,178,255,0.15);
}
/* üåü Vi·ªÅn s√°ng m∆∞·ª£t khi hover v√†o khung ƒëƒÉng b√†i */
.card:first-of-type {
  position: relative;
  border: 1px solid var(--glass-border-color);
  transition: border-color 0.3s ease, box-shadow 0.4s ease;
}

/* Khi di chu·ªôt v√†o th√¨ vi·ªÅn s√°ng l√™n m∆∞·ª£t */
.card:first-of-type:hover {
  border-color: rgba(121,178,255,0.8);
  box-shadow:
    0 0 8px rgba(121,178,255,0.3),
    0 0 15px rgba(121,178,255,0.2),
    0 0 25px rgba(121,178,255,0.15);
}

/* üßä X√≥a hi·ªáu ·ª©ng vi·ªÅn khi focus v√†o textarea ho·∫∑c form */
#postForm textarea:focus,
#postForm:focus-within {
  border-color: var(--glass-border-color);
  box-shadow: none;
  outline: none;
}
/* üåü Vi·ªÅn s√°ng m∆∞·ª£t khi di chu·ªôt v√†o textarea */
#postForm textarea {
  border: 1px solid var(--glass-border-color);
  background: rgba(0, 0, 0, 0.25);
  color: var(--primary-text-color);
  border-radius: 12px;
  padding: 15px;
  transition: all 0.3s ease;
  outline: none;
  resize: vertical;
}

/* Khi di chu·ªôt v√†o ‚Äì vi·ªÅn s√°ng l√™n m∆∞·ª£t */
#postForm textarea:hover {
  border-color: rgba(121,178,255,0.7);
  box-shadow:
    0 0 6px rgba(121,178,255,0.3),
    0 0 12px rgba(121,178,255,0.2);
}

/* Khi click v√†o (focus) ‚Äì v·∫´n gi·ªØ hi·ªáu ·ª©ng nh·∫π nh√†ng */
#postForm textarea:focus {
  border-color: rgba(121,178,255,0.9);
  box-shadow:
    0 0 8px rgba(121,178,255,0.4),
    0 0 16px rgba(121,178,255,0.25);
  background: rgba(0, 0, 0, 0.3);
}


  </style>
</head>
<body>
  <main>
    <div class="container">
      <h1 class="page-title">üí¨ G√ìC H·ªéI ƒê√ÅP</h1>

      <div class="card">
        <form id="postForm" enctype="multipart/form-data">
          <textarea name="caption" placeholder="B·∫°n ƒëang nghƒ© g√¨?"></textarea>
          <div id="imagePreview"></div>
          <div class="post-form-controls">
            <label class="btn">
              <i class="fas fa-paperclip"></i> ·∫¢nh
              <input type="file" name="image" id="imageUpload" accept="image/*" hidden>
            </label>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-paper-plane"></i> ƒêƒÉng b√†i
            </button>
          </div>
        </form>
      </div>

      <div id="posts"></div>
    </div>
  </main>

  <div id="notification-container"></div>

  <script>
    let currentUser = null;

    function showNotification(msg, type='success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = msg;
      document.getElementById('notification-container').appendChild(toast);
      setTimeout(()=>toast.remove(), 3000);
    }

    async function getCurrentUser() {
      try {
        const res = await fetch('/me', { credentials: 'include' });
        if (res.ok) currentUser = await res.json();
      } catch {}
    }

    const postForm = document.getElementById('postForm');
    const imageUpload = document.getElementById('imageUpload');
    const preview = document.getElementById('imagePreview');
    const postsContainer = document.getElementById('posts');

    imageUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      preview.innerHTML = '';
      if (file) {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        preview.appendChild(img);
      }
    });

    postForm.addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(postForm);
      if (!formData.get('caption').trim() && !formData.get('image').size) {
        showNotification('Vui l√≤ng nh·∫≠p n·ªôi dung ho·∫∑c ch·ªçn ·∫£nh!', 'error');
        return;
      }
      try {
        const res = await fetch('/api/posts', {
          method: 'POST',
          body: formData,
          credentials: 'include'
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.message);
        }
        postForm.reset();
        preview.innerHTML = '';
        showNotification('ƒêƒÉng b√†i th√†nh c√¥ng!');
        loadPosts();
      } catch (err) {
        showNotification(err.message, 'error');
      }
    });

    function renderPost(p) {
      const isAdmin = currentUser?.username === 'Vuvantuan1122';
      const div = document.createElement('div');
      div.className = 'card';
      div.dataset.id = p._id;
      div.innerHTML = `
        <div class="post-header">
          <div>
            <span class="post-author">${p.author || '·∫®n danh'}</span><br>
            <span class="post-time">${new Date(p.createdAt).toLocaleString('vi-VN')}</span>
          </div>
          <div class="post-actions">
            <button class="btn-report" title="B√°o c√°o"><i class="fas fa-flag"></i></button>
            ${isAdmin ? `<button class="btn-delete" title="X√≥a"><i class="fas fa-trash"></i></button>` : ''}
          </div>
        </div>
        <p class="post-caption">${p.caption || ''}</p>
        ${p.imageUrl ? `<div class="post-image"><img src="${p.imageUrl}"></div>` : ''}
        <div class="comments-section">
          <h4>B√¨nh lu·∫≠n</h4>
          <div class="comment-list"></div>
          <form class="comment-form" enctype="multipart/form-data">
            <label title="·∫¢nh"><i class="fas fa-paperclip"></i><input type="file" name="image" accept="image/*" hidden></label>
            <input type="text" name="content" placeholder="Vi·∫øt b√¨nh lu·∫≠n...">
            <button type="submit"><i class="fas fa-paper-plane"></i></button>
          </form>
        </div>`;
      return div;
    }

    async function loadPosts() {
      const res = await fetch('/api/posts', { credentials: 'include' });
      const data = await res.json();
      postsContainer.innerHTML = '';
      for (const p of data) {
        const el = renderPost(p);
        postsContainer.appendChild(el);
        loadComments(p._id);
      }
    }

    async function loadComments(postId) {
      const res = await fetch(`/api/posts/${postId}/comments`);
      const comments = await res.json();
      const list = document.querySelector(`.card[data-id="${postId}"] .comment-list`);
      list.innerHTML = '';
      comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment';
        div.innerHTML = `
          <div class="comment-header">
            <span class="comment-author">${c.author}</span>
            <span class="comment-meta">${new Date(c.createdAt).toLocaleString('vi-VN')}</span>
          </div>
          <div class="comment-content">
            <p>${c.content || ''}</p>
            ${c.imageUrl ? `<img src="${c.imageUrl}">` : ''}
          </div>`;
        list.appendChild(div);
      });
    }

    document.addEventListener('submit', async e => {
      const form = e.target;
      if (form.matches('.comment-form')) {
        e.preventDefault();
        const postId = form.closest('.card').dataset.id;
        const formData = new FormData(form);
        if (!formData.get('content').trim() && !formData.get('image').size) return;
        await fetch(`/api/posts/${postId}/comments`, { method:'POST', body: formData, credentials:'include' });
        form.reset();
        loadComments(postId);
      }
    });

    document.addEventListener('click', async e => {
      const btn = e.target.closest('.btn-delete, .btn-report');
      if (!btn) return;
      const postId = btn.closest('.card').dataset.id;
      if (btn.classList.contains('btn-delete')) {
        if (confirm('X√≥a b√†i n√†y?')) {
          const res = await fetch(`/api/posts/${postId}`, { method:'DELETE', credentials:'include' });
          const data = await res.json();
          if (data.success) showNotification('ƒê√£ x√≥a b√†i!', 'success');
          loadPosts();
        }
      } else if (btn.classList.contains('btn-report')) {
        const reason = prompt('Nh·∫≠p l√Ω do b√°o c√°o:');
        if (!reason) return;
        const res = await fetch('/api/reports', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ postId, reason }),
          credentials:'include'
        });
        const data = await res.json();
        if (data.success) showNotification('ƒê√£ g·ª≠i b√°o c√°o!', 'success');
      }
    });

    getCurrentUser().then(loadPosts);
    
  </script>
</body>
</html>